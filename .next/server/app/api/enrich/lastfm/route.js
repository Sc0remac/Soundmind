"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(() => {
var exports = {};
exports.id = "app/api/enrich/lastfm/route";
exports.ids = ["app/api/enrich/lastfm/route"];
exports.modules = {

/***/ "next/dist/compiled/next-server/app-page.runtime.dev.js":
/*!*************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-page.runtime.dev.js" ***!
  \*************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-page.runtime.dev.js");

/***/ }),

/***/ "next/dist/compiled/next-server/app-route.runtime.dev.js":
/*!**************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-route.runtime.dev.js" ***!
  \**************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-route.runtime.dev.js");

/***/ }),

/***/ "http":
/*!***********************!*\
  !*** external "http" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("http");

/***/ }),

/***/ "https":
/*!************************!*\
  !*** external "https" ***!
  \************************/
/***/ ((module) => {

module.exports = require("https");

/***/ }),

/***/ "punycode":
/*!***************************!*\
  !*** external "punycode" ***!
  \***************************/
/***/ ((module) => {

module.exports = require("punycode");

/***/ }),

/***/ "stream":
/*!*************************!*\
  !*** external "stream" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("stream");

/***/ }),

/***/ "url":
/*!**********************!*\
  !*** external "url" ***!
  \**********************/
/***/ ((module) => {

module.exports = require("url");

/***/ }),

/***/ "zlib":
/*!***********************!*\
  !*** external "zlib" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("zlib");

/***/ }),

/***/ "(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fenrich%2Flastfm%2Froute&page=%2Fapi%2Fenrich%2Flastfm%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fenrich%2Flastfm%2Froute.ts&appDir=%2FUsers%2Fcormackerr%2FDesktop%2Fsoundmind%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Fcormackerr%2FDesktop%2Fsoundmind&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!":
/*!***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fenrich%2Flastfm%2Froute&page=%2Fapi%2Fenrich%2Flastfm%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fenrich%2Flastfm%2Froute.ts&appDir=%2FUsers%2Fcormackerr%2FDesktop%2Fsoundmind%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Fcormackerr%2FDesktop%2Fsoundmind&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D! ***!
  \***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   originalPathname: () => (/* binding */ originalPathname),\n/* harmony export */   patchFetch: () => (/* binding */ patchFetch),\n/* harmony export */   requestAsyncStorage: () => (/* binding */ requestAsyncStorage),\n/* harmony export */   routeModule: () => (/* binding */ routeModule),\n/* harmony export */   serverHooks: () => (/* binding */ serverHooks),\n/* harmony export */   staticGenerationAsyncStorage: () => (/* binding */ staticGenerationAsyncStorage)\n/* harmony export */ });\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/dist/server/future/route-modules/app-route/module.compiled */ \"(rsc)/./node_modules/next/dist/server/future/route-modules/app-route/module.compiled.js\");\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/dist/server/future/route-kind */ \"(rsc)/./node_modules/next/dist/server/future/route-kind.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! next/dist/server/lib/patch-fetch */ \"(rsc)/./node_modules/next/dist/server/lib/patch-fetch.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var _Users_cormackerr_Desktop_soundmind_app_api_enrich_lastfm_route_ts__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./app/api/enrich/lastfm/route.ts */ \"(rsc)/./app/api/enrich/lastfm/route.ts\");\n\n\n\n\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__.AppRouteRouteModule({\n    definition: {\n        kind: next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__.RouteKind.APP_ROUTE,\n        page: \"/api/enrich/lastfm/route\",\n        pathname: \"/api/enrich/lastfm\",\n        filename: \"route\",\n        bundlePath: \"app/api/enrich/lastfm/route\"\n    },\n    resolvedPagePath: \"/Users/cormackerr/Desktop/soundmind/app/api/enrich/lastfm/route.ts\",\n    nextConfigOutput,\n    userland: _Users_cormackerr_Desktop_soundmind_app_api_enrich_lastfm_route_ts__WEBPACK_IMPORTED_MODULE_3__\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks } = routeModule;\nconst originalPathname = \"/api/enrich/lastfm/route\";\nfunction patchFetch() {\n    return (0,next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__.patchFetch)({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\n\n\n//# sourceMappingURL=app-route.js.map//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9ub2RlX21vZHVsZXMvbmV4dC9kaXN0L2J1aWxkL3dlYnBhY2svbG9hZGVycy9uZXh0LWFwcC1sb2FkZXIuanM/bmFtZT1hcHAlMkZhcGklMkZlbnJpY2glMkZsYXN0Zm0lMkZyb3V0ZSZwYWdlPSUyRmFwaSUyRmVucmljaCUyRmxhc3RmbSUyRnJvdXRlJmFwcFBhdGhzPSZwYWdlUGF0aD1wcml2YXRlLW5leHQtYXBwLWRpciUyRmFwaSUyRmVucmljaCUyRmxhc3RmbSUyRnJvdXRlLnRzJmFwcERpcj0lMkZVc2VycyUyRmNvcm1hY2tlcnIlMkZEZXNrdG9wJTJGc291bmRtaW5kJTJGYXBwJnBhZ2VFeHRlbnNpb25zPXRzeCZwYWdlRXh0ZW5zaW9ucz10cyZwYWdlRXh0ZW5zaW9ucz1qc3gmcGFnZUV4dGVuc2lvbnM9anMmcm9vdERpcj0lMkZVc2VycyUyRmNvcm1hY2tlcnIlMkZEZXNrdG9wJTJGc291bmRtaW5kJmlzRGV2PXRydWUmdHNjb25maWdQYXRoPXRzY29uZmlnLmpzb24mYmFzZVBhdGg9JmFzc2V0UHJlZml4PSZuZXh0Q29uZmlnT3V0cHV0PSZwcmVmZXJyZWRSZWdpb249Jm1pZGRsZXdhcmVDb25maWc9ZTMwJTNEISIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7QUFBc0c7QUFDdkM7QUFDYztBQUNrQjtBQUMvRjtBQUNBO0FBQ0E7QUFDQSx3QkFBd0IsZ0hBQW1CO0FBQzNDO0FBQ0EsY0FBYyx5RUFBUztBQUN2QjtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsWUFBWTtBQUNaLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQSxRQUFRLGlFQUFpRTtBQUN6RTtBQUNBO0FBQ0EsV0FBVyw0RUFBVztBQUN0QjtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ3VIOztBQUV2SCIsInNvdXJjZXMiOlsid2VicGFjazovL3NvdW5kbWluZC8/OTg4NSJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHBSb3V0ZVJvdXRlTW9kdWxlIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvZnV0dXJlL3JvdXRlLW1vZHVsZXMvYXBwLXJvdXRlL21vZHVsZS5jb21waWxlZFwiO1xuaW1wb3J0IHsgUm91dGVLaW5kIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvZnV0dXJlL3JvdXRlLWtpbmRcIjtcbmltcG9ydCB7IHBhdGNoRmV0Y2ggYXMgX3BhdGNoRmV0Y2ggfSBmcm9tIFwibmV4dC9kaXN0L3NlcnZlci9saWIvcGF0Y2gtZmV0Y2hcIjtcbmltcG9ydCAqIGFzIHVzZXJsYW5kIGZyb20gXCIvVXNlcnMvY29ybWFja2Vyci9EZXNrdG9wL3NvdW5kbWluZC9hcHAvYXBpL2VucmljaC9sYXN0Zm0vcm91dGUudHNcIjtcbi8vIFdlIGluamVjdCB0aGUgbmV4dENvbmZpZ091dHB1dCBoZXJlIHNvIHRoYXQgd2UgY2FuIHVzZSB0aGVtIGluIHRoZSByb3V0ZVxuLy8gbW9kdWxlLlxuY29uc3QgbmV4dENvbmZpZ091dHB1dCA9IFwiXCJcbmNvbnN0IHJvdXRlTW9kdWxlID0gbmV3IEFwcFJvdXRlUm91dGVNb2R1bGUoe1xuICAgIGRlZmluaXRpb246IHtcbiAgICAgICAga2luZDogUm91dGVLaW5kLkFQUF9ST1VURSxcbiAgICAgICAgcGFnZTogXCIvYXBpL2VucmljaC9sYXN0Zm0vcm91dGVcIixcbiAgICAgICAgcGF0aG5hbWU6IFwiL2FwaS9lbnJpY2gvbGFzdGZtXCIsXG4gICAgICAgIGZpbGVuYW1lOiBcInJvdXRlXCIsXG4gICAgICAgIGJ1bmRsZVBhdGg6IFwiYXBwL2FwaS9lbnJpY2gvbGFzdGZtL3JvdXRlXCJcbiAgICB9LFxuICAgIHJlc29sdmVkUGFnZVBhdGg6IFwiL1VzZXJzL2Nvcm1hY2tlcnIvRGVza3RvcC9zb3VuZG1pbmQvYXBwL2FwaS9lbnJpY2gvbGFzdGZtL3JvdXRlLnRzXCIsXG4gICAgbmV4dENvbmZpZ091dHB1dCxcbiAgICB1c2VybGFuZFxufSk7XG4vLyBQdWxsIG91dCB0aGUgZXhwb3J0cyB0aGF0IHdlIG5lZWQgdG8gZXhwb3NlIGZyb20gdGhlIG1vZHVsZS4gVGhpcyBzaG91bGRcbi8vIGJlIGVsaW1pbmF0ZWQgd2hlbiB3ZSd2ZSBtb3ZlZCB0aGUgb3RoZXIgcm91dGVzIHRvIHRoZSBuZXcgZm9ybWF0LiBUaGVzZVxuLy8gYXJlIHVzZWQgdG8gaG9vayBpbnRvIHRoZSByb3V0ZS5cbmNvbnN0IHsgcmVxdWVzdEFzeW5jU3RvcmFnZSwgc3RhdGljR2VuZXJhdGlvbkFzeW5jU3RvcmFnZSwgc2VydmVySG9va3MgfSA9IHJvdXRlTW9kdWxlO1xuY29uc3Qgb3JpZ2luYWxQYXRobmFtZSA9IFwiL2FwaS9lbnJpY2gvbGFzdGZtL3JvdXRlXCI7XG5mdW5jdGlvbiBwYXRjaEZldGNoKCkge1xuICAgIHJldHVybiBfcGF0Y2hGZXRjaCh7XG4gICAgICAgIHNlcnZlckhvb2tzLFxuICAgICAgICBzdGF0aWNHZW5lcmF0aW9uQXN5bmNTdG9yYWdlXG4gICAgfSk7XG59XG5leHBvcnQgeyByb3V0ZU1vZHVsZSwgcmVxdWVzdEFzeW5jU3RvcmFnZSwgc3RhdGljR2VuZXJhdGlvbkFzeW5jU3RvcmFnZSwgc2VydmVySG9va3MsIG9yaWdpbmFsUGF0aG5hbWUsIHBhdGNoRmV0Y2gsICB9O1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1hcHAtcm91dGUuanMubWFwIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fenrich%2Flastfm%2Froute&page=%2Fapi%2Fenrich%2Flastfm%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fenrich%2Flastfm%2Froute.ts&appDir=%2FUsers%2Fcormackerr%2FDesktop%2Fsoundmind%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Fcormackerr%2FDesktop%2Fsoundmind&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!\n");

/***/ }),

/***/ "(rsc)/./app/api/enrich/lastfm/route.ts":
/*!****************************************!*\
  !*** ./app/api/enrich/lastfm/route.ts ***!
  \****************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   POST: () => (/* binding */ POST)\n/* harmony export */ });\n/* harmony import */ var next_server__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/server */ \"(rsc)/./node_modules/next/dist/api/server.js\");\n/* harmony import */ var _lib_supabaseAdmin__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @/lib/supabaseAdmin */ \"(rsc)/./lib/supabaseAdmin.ts\");\n// app/api/enrich/lastfm/route.ts\n\n\n/**\n * LAST.FM ENRICHMENT\n * - Looks at your most recent listens (last 100) and enriches their tracks with:\n *   - genre_primary   (string)\n *   - genre_tags      (string[])\n *   - derived_energy  (0..1)\n *   - derived_valence (0..1)\n *\n * We use last.fm track.getTopTags + artist.getTopTags.\n * No user auth: requires LASTFM_API_KEY in env.\n */ const LASTFM_KEY = process.env.LASTFM_API_KEY;\n// Basic tag normalization/aliases\nconst TAG_ALIAS = {\n    \"hip hop\": \"hip-hop\",\n    hiphop: \"hip-hop\",\n    \"lo fi\": \"lo-fi\",\n    lofi: \"lo-fi\",\n    edm: \"edm\",\n    dnb: \"drum-and-bass\",\n    \"drum n bass\": \"drum-and-bass\",\n    \"drum & bass\": \"drum-and-bass\",\n    house: \"house\",\n    techno: \"techno\",\n    trance: \"trance\",\n    ambient: \"ambient\",\n    chill: \"chill\",\n    \"chill out\": \"chill\",\n    rock: \"rock\",\n    metal: \"metal\",\n    pop: \"pop\",\n    trap: \"trap\",\n    dance: \"dance\",\n    \"r&b\": \"rnb\",\n    \"rnb\": \"rnb\"\n};\n// Heuristic maps for deriving energy/valence from tags.\n// NOTE: keys with hyphens MUST be quoted in TS.\nconst TAG_TO_ENERGY = {\n    rave: 0.9,\n    hardstyle: 0.95,\n    edm: 0.8,\n    dance: 0.7,\n    rock: 0.7,\n    techno: 0.8,\n    house: 0.7,\n    chill: 0.2,\n    ambient: 0.1,\n    acoustic: 0.2,\n    downtempo: 0.3,\n    \"lo-fi\": 0.25,\n    lofi: 0.25,\n    pop: 0.6,\n    hiphop: 0.6,\n    \"hip-hop\": 0.6,\n    trap: 0.7,\n    metal: 0.85,\n    trance: 0.75,\n    \"drum-and-bass\": 0.85\n};\nconst TAG_TO_VALENCE = {\n    happy: 0.9,\n    upbeat: 0.8,\n    uplifting: 0.8,\n    melancholic: 0.2,\n    sad: 0.1,\n    dark: 0.2,\n    chill: 0.6,\n    ambient: 0.5,\n    acoustic: 0.7,\n    pop: 0.7,\n    \"hip-hop\": 0.6,\n    hiphop: 0.6,\n    trap: 0.5,\n    techno: 0.4,\n    metal: 0.3,\n    trance: 0.6\n};\n// Useful stopwords we don’t want as “genres”\nconst TAG_STOP = new Set([\n    \"seen live\",\n    \"favorites\",\n    \"favorite\",\n    \"awesome\",\n    \"90s\",\n    \"00s\",\n    \"2010s\",\n    \"2020s\",\n    \"uk\",\n    \"usa\",\n    \"british\",\n    \"swedish\",\n    \"german\",\n    \"female vocalists\",\n    \"male vocalists\"\n]);\nfunction normalizeTag(t) {\n    const s = t.trim().toLowerCase();\n    const clean = s.replace(/\\s+/g, \" \"); // collapse spaces\n    const alias = TAG_ALIAS[clean] || clean;\n    // strip non-word characters except space and hyphen\n    return alias.replace(/[^\\w\\s-]/g, \"\").trim();\n}\nfunction scoreTags(tags) {\n    // Return cleaned, weighted tag list and top candidates for genre_primary\n    const map = new Map();\n    for (const tag of tags || []){\n        if (!tag?.name) continue;\n        let n = normalizeTag(tag.name);\n        if (!n || TAG_STOP.has(n)) continue;\n        const w = Math.max(1, Number(tag.count || 1));\n        map.set(n, (map.get(n) || 0) + w);\n    }\n    // sort by weight desc\n    const entries = [\n        ...map.entries()\n    ].sort((a, b)=>b[1] - a[1]);\n    const ordered = entries.map(([k])=>k);\n    const top = entries.length > 0 ? entries[0][0] : null;\n    return {\n        ordered,\n        top\n    };\n}\nfunction deriveEnergyValence(tags) {\n    if (!tags?.length) return {\n        energy: null,\n        valence: null\n    };\n    let eSum = 0, eN = 0, vSum = 0, vN = 0;\n    for (const t of tags){\n        if (t in TAG_TO_ENERGY) {\n            eSum += TAG_TO_ENERGY[t];\n            eN++;\n        }\n        if (t in TAG_TO_VALENCE) {\n            vSum += TAG_TO_VALENCE[t];\n            vN++;\n        }\n    }\n    return {\n        energy: eN ? Number((eSum / eN).toFixed(3)) : null,\n        valence: vN ? Number((vSum / vN).toFixed(3)) : null\n    };\n}\nasync function lf(method, params) {\n    const url = new URL(\"https://ws.audioscrobbler.com/2.0/\");\n    url.searchParams.set(\"method\", method);\n    url.searchParams.set(\"api_key\", String(LASTFM_KEY));\n    url.searchParams.set(\"format\", \"json\");\n    for (const [k, v] of Object.entries(params))url.searchParams.set(k, v);\n    const r = await fetch(url.toString(), {\n        next: {\n            revalidate: 0\n        }\n    });\n    if (!r.ok) throw new Error(`Last.fm ${method} ${r.status}`);\n    return r.json();\n}\nasync function fetchTagsFor(artist, track) {\n    const tags = [];\n    try {\n        const jt = await lf(\"track.getTopTags\", {\n            artist,\n            track,\n            autocorrect: \"1\"\n        });\n        if (jt?.toptags?.tag?.length) tags.push(...jt.toptags.tag);\n    } catch  {\n    // ignore\n    }\n    // If nothing from track, try artist\n    if (tags.length === 0) {\n        try {\n            const ja = await lf(\"artist.getTopTags\", {\n                artist,\n                autocorrect: \"1\"\n            });\n            if (ja?.toptags?.tag?.length) tags.push(...ja.toptags.tag);\n        } catch  {\n        // ignore\n        }\n    }\n    return tags;\n}\nasync function POST() {\n    if (!LASTFM_KEY) {\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            ok: false,\n            error: \"Missing LASTFM_API_KEY\"\n        }, {\n            status: 500\n        });\n    }\n    // 1) Get the last 100 listened track IDs\n    const { data: listens, error: lErr } = await _lib_supabaseAdmin__WEBPACK_IMPORTED_MODULE_1__.supabaseAdmin.from(\"spotify_listens\").select(\"track_id\").order(\"played_at\", {\n        ascending: false\n    }).limit(100);\n    if (lErr) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n        ok: false,\n        error: lErr.message\n    }, {\n        status: 500\n    });\n    const ids = Array.from(new Set(listens?.map((r)=>r.track_id) || [])).slice(0, 100);\n    if (ids.length === 0) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n        ok: true,\n        updated: 0,\n        note: \"No recent listens\"\n    });\n    // 2) Fetch tracks + artists\n    const [{ data: tracks, error: tErr }, { data: links }, { data: artists }] = await Promise.all([\n        _lib_supabaseAdmin__WEBPACK_IMPORTED_MODULE_1__.supabaseAdmin.from(\"spotify_tracks\").select(\"id,name,genre_primary,genre_tags,artist_name\").in(\"id\", ids),\n        _lib_supabaseAdmin__WEBPACK_IMPORTED_MODULE_1__.supabaseAdmin.from(\"spotify_track_artists\").select(\"track_id,artist_id\").in(\"track_id\", ids),\n        _lib_supabaseAdmin__WEBPACK_IMPORTED_MODULE_1__.supabaseAdmin.from(\"spotify_artists\").select(\"id,name\")\n    ]);\n    if (tErr) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n        ok: false,\n        error: tErr.message\n    }, {\n        status: 500\n    });\n    const artistMap = new Map();\n    artists?.forEach((a)=>artistMap.set(a.id, a.name));\n    const trackArtists = new Map();\n    links?.forEach((lnk)=>{\n        const arr = trackArtists.get(lnk.track_id) || [];\n        const nm = artistMap.get(lnk.artist_id);\n        if (nm) arr.push(nm);\n        trackArtists.set(lnk.track_id, arr);\n    });\n    // 3) For each track, call last.fm and update the row\n    let updated = 0;\n    const results = [];\n    for (const tr of tracks){\n        let artistsForTrack = trackArtists.get(tr.id) || [];\n        if ((!artistsForTrack || artistsForTrack.length === 0) && tr.artist_name) {\n            artistsForTrack = String(tr.artist_name).split(\",\").map((s)=>s.trim()).filter(Boolean);\n        }\n        const artist = artistsForTrack[0] || \"\"; // pick the first (primary) artist\n        if (!artist || !tr.name) continue;\n        const tags = await fetchTagsFor(artist, tr.name);\n        const { ordered, top } = scoreTags(tags);\n        const { energy, valence } = deriveEnergyValence(ordered);\n        const genre_primary = top || tr.genre_primary || null;\n        const genre_tags = ordered.slice(0, 8);\n        const { error: uErr } = await _lib_supabaseAdmin__WEBPACK_IMPORTED_MODULE_1__.supabaseAdmin.from(\"spotify_tracks\").update({\n            genre_primary,\n            genre_tags: genre_tags.length ? genre_tags : null,\n            derived_energy: energy,\n            derived_valence: valence,\n            last_enriched_at: new Date().toISOString(),\n            meta_provider: {\n                ...typeof tr.meta_provider === \"object\" ? tr.meta_provider : {},\n                lastfm: {\n                    ok: true,\n                    tagsFetched: tags.length,\n                    artist,\n                    track: tr.name\n                }\n            }\n        }).eq(\"id\", tr.id);\n        results.push({\n            id: tr.id,\n            track: tr.name,\n            artist,\n            topTag: genre_primary,\n            tagCount: tags.length,\n            updated: !uErr,\n            error: uErr?.message || null\n        });\n        if (!uErr) updated++;\n        // Small delay to be polite to Last.fm\n        await new Promise((r)=>setTimeout(r, 120));\n    }\n    return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n        ok: true,\n        updated,\n        processed: tracks?.length || 0,\n        results\n    });\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9hcHAvYXBpL2VucmljaC9sYXN0Zm0vcm91dGUudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsaUNBQWlDO0FBQ1U7QUFDUztBQUVwRDs7Ozs7Ozs7OztDQVVDLEdBRUQsTUFBTUUsYUFBYUMsUUFBUUMsR0FBRyxDQUFDQyxjQUFjO0FBRTdDLGtDQUFrQztBQUNsQyxNQUFNQyxZQUFvQztJQUN4QyxXQUFXO0lBQ1hDLFFBQVE7SUFDUixTQUFTO0lBQ1RDLE1BQU07SUFDTkMsS0FBSztJQUNMQyxLQUFLO0lBQ0wsZUFBZTtJQUNmLGVBQWU7SUFDZkMsT0FBTztJQUNQQyxRQUFRO0lBQ1JDLFFBQVE7SUFDUkMsU0FBUztJQUNUQyxPQUFPO0lBQ1AsYUFBYTtJQUNiQyxNQUFNO0lBQ05DLE9BQU87SUFDUEMsS0FBSztJQUNMQyxNQUFNO0lBQ05DLE9BQU87SUFDUCxPQUFPO0lBQ1AsT0FBTztBQUNUO0FBRUEsd0RBQXdEO0FBQ3hELGdEQUFnRDtBQUNoRCxNQUFNQyxnQkFBd0M7SUFDNUNDLE1BQU07SUFDTkMsV0FBVztJQUNYZCxLQUFLO0lBQ0xXLE9BQU87SUFDUEosTUFBTTtJQUNOSixRQUFRO0lBQ1JELE9BQU87SUFDUEksT0FBTztJQUNQRCxTQUFTO0lBQ1RVLFVBQVU7SUFDVkMsV0FBVztJQUNYLFNBQVM7SUFDVGpCLE1BQU07SUFDTlUsS0FBSztJQUNMWCxRQUFRO0lBQ1IsV0FBVztJQUNYWSxNQUFNO0lBQ05GLE9BQU87SUFDUEosUUFBUTtJQUNSLGlCQUFpQjtBQUNuQjtBQUVBLE1BQU1hLGlCQUF5QztJQUM3Q0MsT0FBTztJQUNQQyxRQUFRO0lBQ1JDLFdBQVc7SUFDWEMsYUFBYTtJQUNiQyxLQUFLO0lBQ0xDLE1BQU07SUFDTmpCLE9BQU87SUFDUEQsU0FBUztJQUNUVSxVQUFVO0lBQ1ZOLEtBQUs7SUFDTCxXQUFXO0lBQ1hYLFFBQVE7SUFDUlksTUFBTTtJQUNOUCxRQUFRO0lBQ1JLLE9BQU87SUFDUEosUUFBUTtBQUNWO0FBRUEsNkNB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UW9ELEtBQUssQ0FBQyxHQUFHO1FBRXBDLE1BQU0sRUFBRWIsT0FBT3dDLElBQUksRUFBRSxHQUFHLE1BQU01SSw2REFBYUEsQ0FDeEN3RyxJQUFJLENBQUMsa0JBQ0xxQyxNQUFNLENBQUM7WUFDTkg7WUFDQUMsWUFBWUEsV0FBVzNFLE1BQU0sR0FBRzJFLGFBQWE7WUFDN0NHLGdCQUFnQjVFO1lBQ2hCNkUsaUJBQWlCNUU7WUFDakI2RSxrQkFBa0IsSUFBSUMsT0FBT0MsV0FBVztZQUN4Q0MsZUFBZTtnQkFDYixHQUFJLE9BQU8sR0FBWUEsYUFBYSxLQUFLLFdBQVcsR0FBWUEsYUFBYSxHQUFHLENBQUMsQ0FBQztnQkFDbEZDLFFBQVE7b0JBQUU3RCxJQUFJO29CQUFNOEQsYUFBYTFHLEtBQUtxQixNQUFNO29CQUFFNEI7b0JBQVFDLE9BQU91QyxHQUFHckYsSUFBSTtnQkFBQztZQUN2RTtRQUNGLEdBQ0N1RyxFQUFFLENBQUMsTUFBTWxCLEdBQUdQLEVBQUU7UUFFakJNLFFBQVFsQyxJQUFJLENBQUM7WUFDWDRCLElBQUlPLEdBQUdQLEVBQUU7WUFDVGhDLE9BQU91QyxHQUFHckYsSUFBSTtZQUNkNkM7WUFDQTJELFFBQVFiO1lBQ1JjLFVBQVU3RyxLQUFLcUIsTUFBTTtZQUNyQmtELFNBQVMsQ0FBQzBCO1lBQ1Z4QyxPQUFPd0MsTUFBTS9CLFdBQVc7UUFDMUI7UUFFQSxJQUFJLENBQUMrQixNQUFNMUI7UUFDWCxzQ0FBc0M7UUFDdEMsTUFBTSxJQUFJTSxRQUFRLENBQUN0QyxJQUFNdUUsV0FBV3ZFLEdBQUc7SUFDekM7SUFFQSxPQUFPbkYscURBQVlBLENBQUMyRixJQUFJLENBQUM7UUFBRUgsSUFBSTtRQUFNMkI7UUFBU3dDLFdBQVd0QyxRQUFRcEQsVUFBVTtRQUFHbUU7SUFBUTtBQUN4RiIsInNvdXJjZXMiOlsid2VicGFjazovL3NvdW5kbWluZC8uL2FwcC9hcGkvZW5yaWNoL2xhc3RmbS9yb3V0ZS50cz8xZWI2Il0sInNvdXJjZXNDb250ZW50IjpbIi8vIGFwcC9hcGkvZW5yaWNoL2xhc3RmbS9yb3V0ZS50c1xuaW1wb3J0IHsgTmV4dFJlc3BvbnNlIH0gZnJvbSBcIm5leHQvc2VydmVyXCI7XG5pbXBvcnQgeyBzdXBhYmFzZUFkbWluIH0gZnJvbSBcIkAvbGliL3N1cGFiYXNlQWRtaW5cIjtcblxuLyoqXG4gKiBMQVNULkZNIEVOUklDSE1FTlRcbiAqIC0gTG9va3MgYXQgeW91ciBtb3N0IHJlY2VudCBsaXN0ZW5zIChsYXN0IDEwMCkgYW5kIGVucmljaGVzIHRoZWlyIHRyYWNrcyB3aXRoOlxuICogICAtIGdlbnJlX3ByaW1hcnkgICAoc3RyaW5nKVxuICogICAtIGdlbnJlX3RhZ3MgICAgICAoc3RyaW5nW10pXG4gKiAgIC0gZGVyaXZlZF9lbmVyZ3kgICgwLi4xKVxuICogICAtIGRlcml2ZWRfdmFsZW5jZSAoMC4uMSlcbiAqXG4gKiBXZSB1c2UgbGFzdC5mbSB0cmFjay5nZXRUb3BUYWdzICsgYXJ0aXN0LmdldFRvcFRhZ3MuXG4gKiBObyB1c2VyIGF1dGg6IHJlcXVpcmVzIExBU1RGTV9BUElfS0VZIGluIGVudi5cbiAqL1xuXG5jb25zdCBMQVNURk1fS0VZID0gcHJvY2Vzcy5lbnYuTEFTVEZNX0FQSV9LRVk7XG5cbi8vIEJhc2ljIHRhZyBub3JtYWxpemF0aW9uL2FsaWFzZXNcbmNvbnN0IFRBR19BTElBUzogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHtcbiAgXCJoaXAgaG9wXCI6IFwiaGlwLWhvcFwiLFxuICBoaXBob3A6IFwiaGlwLWhvcFwiLFxuICBcImxvIGZpXCI6IFwibG8tZmlcIixcbiAgbG9maTogXCJsby1maVwiLFxuICBlZG06IFwiZWRtXCIsXG4gIGRuYjogXCJkcnVtLWFuZC1iYXNzXCIsXG4gIFwiZHJ1bSBuIGJhc3NcIjogXCJkcnVtLWFuZC1iYXNzXCIsXG4gIFwiZHJ1bSAmIGJhc3NcIjogXCJkcnVtLWFuZC1iYXNzXCIsXG4gIGhvdXNlOiBcImhvdXNlXCIsXG4gIHRlY2hubzogXCJ0ZWNobm9cIixcbiAgdHJhbmNlOiBcInRyYW5jZVwiLFxuICBhbWJpZW50OiBcImFtYmllbnRcIixcbiAgY2hpbGw6IFwiY2hpbGxcIixcbiAgXCJjaGlsbCBvdXRcIjogXCJjaGlsbFwiLFxuICByb2NrOiBcInJvY2tcIixcbiAgbWV0YWw6IFwibWV0YWxcIixcbiAgcG9wOiBcInBvcFwiLFxuICB0cmFwOiBcInRyYXBcIixcbiAgZGFuY2U6IFwiZGFuY2VcIixcbiAgXCJyJmJcIjogXCJybmJcIixcbiAgXCJybmJcIjogXCJybmJcIixcbn07XG5cbi8vIEhldXJpc3RpYyBtYXBzIGZvciBkZXJpdmluZyBlbmVyZ3kvdmFsZW5jZSBmcm9tIHRhZ3MuXG4vLyBOT1RFOiBrZXlzIHdpdGggaHlwaGVucyBNVVNUIGJlIHF1b3RlZCBpbiBUUy5cbmNvbnN0IFRBR19UT19FTkVSR1k6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4gPSB7XG4gIHJhdmU6IDAuOSxcbiAgaGFyZHN0eWxlOiAwLjk1LFxuICBlZG06IDAuOCxcbiAgZGFuY2U6IDAuNyxcbiAgcm9jazogMC43LFxuICB0ZWNobm86IDAuOCxcbiAgaG91c2U6IDAuNyxcbiAgY2hpbGw6IDAuMixcbiAgYW1iaWVudDogMC4xLFxuICBhY291c3RpYzogMC4yLFxuICBkb3dudGVtcG86IDAuMyxcbiAgXCJsby1maVwiOiAwLjI1LFxuICBsb2ZpOiAwLjI1LFxuICBwb3A6IDAuNixcbiAgaGlwaG9wOiAwLjYsXG4gIFwiaGlwLWhvcFwiOiAwLjYsXG4gIHRyYXA6IDAuNyxcbiAgbWV0YWw6IDAuODUsXG4gIHRyYW5jZTogMC43NSxcbiAgXCJkcnVtLWFuZC1iYXNzXCI6IDAuODUsXG59O1xuXG5jb25zdCBUQUdfVE9fVkFMRU5DRTogUmVjb3JkPHN0cmluZywgbnVtYmVyPiA9IHtcbiAgaGFwcHk6IDAuOSxcbiAgdXBiZWF0OiAwLjgsXG4gIHVwbGlmdGluZzogMC44LFxuICBtZWxhbmNob2xpYzogMC4yLFxuICBzYWQ6IDAuMSxcbiAgZGFyazogMC4yLFxuICBjaGlsbDogMC42LFxuICBhbWJpZW50OiAwLjUsXG4gIGFjb3VzdGljOiAwLjcsXG4gIHBvcDogMC43LFxuICBcImhpcC1ob3BcIjogMC42LFxuICBoaXBob3A6IDAuNixcbiAgdHJhcDogMC41LFxuICB0ZWNobm86IDAuNCxcbiAgbWV0YWw6IDAuMyxcbiAgdHJhbmNlOiAwLjYsXG59O1xuXG4vLyBVc2VmdWwgc3RvcHdvcmRzIHdlIGRvbuKAmXQgd2FudCBhcyDigJxnZW5yZXPigJ1cbmNvbnN0IFRBR19TVE9QID0gbmV3IFNldChbXG4gIFwic2VlbiBsaXZlXCIsXG4gIFwiZmF2b3JpdGVzXCIsXG4gIFwiZmF2b3JpdGVcIixcbiAgXCJhd2Vzb21lXCIsXG4gIFwiOTBzXCIsXG4gIFwiMDBzXCIsXG4gIFwiMjAxMHNcIixcbiAgXCIyMDIwc1wiLFxuICBcInVrXCIsXG4gIFwidXNhXCIsXG4gIFwiYnJpdGlzaFwiLFxuICBcInN3ZWRpc2hcIixcbiAgXCJnZXJtYW5cIixcbiAgXCJmZW1hbGUgdm9jYWxpc3RzXCIsXG4gIFwibWFsZSB2b2NhbGlzdHNcIixcbl0pO1xuXG50eXBlIExhc3RmbVRhZyA9IHsgbmFtZTogc3RyaW5nOyBjb3VudD86IG51bWJlciB9O1xuXG5mdW5jdGlvbiBub3JtYWxpemVUYWcodDogc3RyaW5nKTogc3RyaW5nIHtcbiAgY29uc3QgcyA9IHQudHJpbSgpLnRvTG93ZXJDYXNlKCk7XG4gIGNvbnN0IGNsZWFuID0gcy5yZXBsYWNlKC9cXHMrL2csIFwiIFwiKTsgLy8gY29sbGFwc2Ugc3BhY2VzXG4gIGNvbnN0IGFsaWFzID0gVEFHX0FMSUFTW2NsZWFuXSB8fCBjbGVhbjtcbiAgLy8gc3RyaXAgbm9uLXdvcmQgY2hhcmFjdGVycyBleGNlcHQgc3BhY2UgYW5kIGh5cGhlblxuICByZXR1cm4gYWxpYXMucmVwbGFjZSgvW15cXHdcXHMtXS9nLCBcIlwiKS50cmltKCk7XG59XG5cbmZ1bmN0aW9uIHNjb3JlVGFncyh0YWdzOiBMYXN0Zm1UYWdbXSkge1xuICAvLyBSZXR1cm4gY2xlYW5lZCwgd2VpZ2h0ZWQgdGFnIGxpc3QgYW5kIHRvcCBjYW5kaWRhdGVzIGZvciBnZW5yZV9wcmltYXJ5XG4gIGNvbnN0IG1hcCA9IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KCk7XG4gIGZvciAoY29uc3QgdGFnIG9mIHRhZ3MgfHwgW10pIHtcbiAgICBpZiAoIXRhZz8ubmFtZSkgY29udGludWU7XG4gICAgbGV0IG4gPSBub3JtYWxpemVUYWcodGFnLm5hbWUpO1xuICAgIGlmICghbiB8fCBUQUdfU1RPUC5oYXMobikpIGNvbnRpbnVlO1xuICAgIGNvbnN0IHcgPSBNYXRoLm1heCgxLCBOdW1iZXIodGFnLmNvdW50IHx8IDEpKTtcbiAgICBtYXAuc2V0KG4sIChtYXAuZ2V0KG4pIHx8IDApICsgdyk7XG4gIH1cbiAgLy8gc29ydCBieSB3ZWlnaHQgZGVzY1xuICBjb25zdCBlbnRyaWVzID0gWy4uLm1hcC5lbnRyaWVzKCldLnNvcnQoKGEsIGIpID0+IGJbMV0gLSBhWzFdKTtcbiAgY29uc3Qgb3JkZXJlZCA9IGVudHJpZXMubWFwKChba10pID0+IGspO1xuICBjb25zdCB0b3AgPSBlbnRyaWVzLmxlbmd0aCA+IDAgPyBlbnRyaWVzWzBdWzBdIDogbnVsbDtcbiAgcmV0dXJuIHsgb3JkZXJlZCwgdG9wIH07XG59XG5cbmZ1bmN0aW9uIGRlcml2ZUVuZXJneVZhbGVuY2UodGFnczogc3RyaW5nW10pIHtcbiAgaWYgKCF0YWdzPy5sZW5ndGgpIHJldHVybiB7IGVuZXJneTogbnVsbCBhcyBudW1iZXIgfCBudWxsLCB2YWxlbmNlOiBudWxsIGFzIG51bWJlciB8IG51bGwgfTtcbiAgbGV0IGVTdW0gPSAwLFxuICAgIGVOID0gMCxcbiAgICB2U3VtID0gMCxcbiAgICB2TiA9IDA7XG4gIGZvciAoY29uc3QgdCBvZiB0YWdzKSB7XG4gICAgaWYgKHQgaW4gVEFHX1RPX0VORVJHWSkge1xuICAgICAgZVN1bSArPSBUQUdfVE9fRU5FUkdZW3RdO1xuICAgICAgZU4rKztcbiAgICB9XG4gICAgaWYgKHQgaW4gVEFHX1RPX1ZBTEVOQ0UpIHtcbiAgICAgIHZTdW0gKz0gVEFHX1RPX1ZBTEVOQ0VbdF07XG4gICAgICB2TisrO1xuICAgIH1cbiAgfVxuICByZXR1cm4ge1xuICAgIGVuZXJneTogZU4gPyBOdW1iZXIoKGVTdW0gLyBlTikudG9GaXhlZCgzKSkgOiBudWxsLFxuICAgIHZhbGVuY2U6IHZOID8gTnVtYmVyKCh2U3VtIC8gdk4pLnRvRml4ZWQoMykpIDogbnVsbCxcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gbGYobWV0aG9kOiBzdHJpbmcsIHBhcmFtczogUmVjb3JkPHN0cmluZywgc3RyaW5nPikge1xuICBjb25zdCB1cmwgPSBuZXcgVVJMKFwiaHR0cHM6Ly93cy5hdWRpb3Njcm9iYmxlci5jb20vMi4wL1wiKTtcbiAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoXCJtZXRob2RcIiwgbWV0aG9kKTtcbiAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoXCJhcGlfa2V5XCIsIFN0cmluZyhMQVNURk1fS0VZKSk7XG4gIHVybC5zZWFyY2hQYXJhbXMuc2V0KFwiZm9ybWF0XCIsIFwianNvblwiKTtcbiAgZm9yIChjb25zdCBbaywgdl0gb2YgT2JqZWN0LmVudHJpZXMocGFyYW1zKSkgdXJsLnNlYXJjaFBhcmFtcy5zZXQoaywgdik7XG4gIGNvbnN0IHIgPSBhd2FpdCBmZXRjaCh1cmwudG9TdHJpbmcoKSwgeyBuZXh0OiB7IHJldmFsaWRhdGU6IDAgfSB9KTtcbiAgaWYgKCFyLm9rKSB0aHJvdyBuZXcgRXJyb3IoYExhc3QuZm0gJHttZXRob2R9ICR7ci5zdGF0dXN9YCk7XG4gIHJldHVybiByLmpzb24oKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZmV0Y2hUYWdzRm9yKGFydGlzdDogc3RyaW5nLCB0cmFjazogc3RyaW5nKTogUHJvbWlzZTxMYXN0Zm1UYWdbXT4ge1xuICBjb25zdCB0YWdzOiBMYXN0Zm1UYWdbXSA9IFtdO1xuICB0cnkge1xuICAgIGNvbnN0IGp0ID0gYXdhaXQgbGYoXCJ0cmFjay5nZXRUb3BUYWdzXCIsIHtcbiAgICAgIGFydGlzdCxcbiAgICAgIHRyYWNrLFxuICAgICAgYXV0b2NvcnJlY3Q6IFwiMVwiLFxuICAgIH0pO1xuICAgIGlmIChqdD8udG9wdGFncz8udGFnPy5sZW5ndGgpIHRhZ3MucHVzaCguLi5qdC50b3B0YWdzLnRhZyk7XG4gIH0gY2F0Y2gge1xuICAgIC8vIGlnbm9yZVxuICB9XG4gIC8vIElmIG5vdGhpbmcgZnJvbSB0cmFjaywgdHJ5IGFydGlzdFxuICBpZiAodGFncy5sZW5ndGggPT09IDApIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgamEgPSBhd2FpdCBsZihcImFydGlzdC5nZXRUb3BUYWdzXCIsIHsgYXJ0aXN0LCBhdXRvY29ycmVjdDogXCIxXCIgfSk7XG4gICAgICBpZiAoamE/LnRvcHRhZ3M/LnRhZz8ubGVuZ3RoKSB0YWdzLnB1c2goLi4uamEudG9wdGFncy50YWcpO1xuICAgIH0gY2F0Y2gge1xuICAgICAgLy8gaWdub3JlXG4gICAgfVxuICB9XG4gIHJldHVybiB0YWdzO1xufVxuXG50eXBlIFRyYWNrUm93ID0ge1xuICBpZDogc3RyaW5nO1xuICBuYW1lOiBzdHJpbmc7XG4gIGdlbnJlX3ByaW1hcnk/OiBzdHJpbmcgfCBudWxsO1xuICBnZW5yZV90YWdzPzogc3RyaW5nW10gfCBudWxsO1xuICBhcnRpc3RfbmFtZT86IHN0cmluZyB8IG51bGw7XG59O1xuXG50eXBlIExpbmtSb3cgPSB7IHRyYWNrX2lkOiBzdHJpbmc7IGFydGlzdF9pZDogc3RyaW5nIH07XG50eXBlIEFydGlzdFJvdyA9IHsgaWQ6IHN0cmluZzsgbmFtZTogc3RyaW5nIH07XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBQT1NUKCkge1xuICBpZiAoIUxBU1RGTV9LRVkpIHtcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICB7IG9rOiBmYWxzZSwgZXJyb3I6IFwiTWlzc2luZyBMQVNURk1fQVBJX0tFWVwiIH0sXG4gICAgICB7IHN0YXR1czogNTAwIH1cbiAgICApO1xuICB9XG5cbiAgLy8gMSkgR2V0IHRoZSBsYXN0IDEwMCBsaXN0ZW5lZCB0cmFjayBJRHNcbiAgY29uc3QgeyBkYXRhOiBsaXN0ZW5zLCBlcnJvcjogbEVyciB9ID0gYXdhaXQgc3VwYWJhc2VBZG1pblxuICAgIC5mcm9tKFwic3BvdGlmeV9saXN0ZW5zXCIpXG4gICAgLnNlbGVjdChcInRyYWNrX2lkXCIpXG4gICAgLm9yZGVyKFwicGxheWVkX2F0XCIsIHsgYXNjZW5kaW5nOiBmYWxzZSB9KVxuICAgIC5saW1pdCgxMDApO1xuICBpZiAobEVycikgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgb2s6IGZhbHNlLCBlcnJvcjogbEVyci5tZXNzYWdlIH0sIHsgc3RhdHVzOiA1MDAgfSk7XG5cbiAgY29uc3QgaWRzID0gQXJyYXkuZnJvbShcbiAgICBuZXcgU2V0KChsaXN0ZW5zIGFzIHsgdHJhY2tfaWQ6IHN0cmluZyB9W10gfCBudWxsIHwgdW5kZWZpbmVkKT8ubWFwKChyKSA9PiByLnRyYWNrX2lkKSB8fCBbXSlcbiAgKS5zbGljZSgwLCAxMDApO1xuICBpZiAoaWRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgb2s6IHRydWUsIHVwZGF0ZWQ6IDAsIG5vdGU6IFwiTm8gcmVjZW50IGxpc3RlbnNcIiB9KTtcblxuICAvLyAyKSBGZXRjaCB0cmFja3MgKyBhcnRpc3RzXG4gIGNvbnN0IFt7IGRhdGE6IHRyYWNrcywgZXJyb3I6IHRFcnIgfSwgeyBkYXRhOiBsaW5rcyB9LCB7IGRhdGE6IGFydGlzdHMgfV0gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgc3VwYWJhc2VBZG1pblxuICAgICAgLmZyb20oXCJzcG90aWZ5X3RyYWNrc1wiKVxuICAgICAgLnNlbGVjdChcImlkLG5hbWUsZ2VucmVfcHJpbWFyeSxnZW5yZV90YWdzLGFydGlzdF9uYW1lXCIpXG4gICAgICAuaW4oXCJpZFwiLCBpZHMpLFxuICAgIHN1cGFiYXNlQWRtaW4uZnJvbShcInNwb3RpZnlfdHJhY2tfYXJ0aXN0c1wiKS5zZWxlY3QoXCJ0cmFja19pZCxhcnRpc3RfaWRcIikuaW4oXCJ0cmFja19pZFwiLCBpZHMpLFxuICAgIHN1cGFiYXNlQWRtaW4uZnJvbShcInNwb3RpZnlfYXJ0aXN0c1wiKS5zZWxlY3QoXCJpZCxuYW1lXCIpLFxuICBdIGFzIGNvbnN0KTtcblxuICBpZiAodEVycikgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgb2s6IGZhbHNlLCBlcnJvcjogdEVyci5tZXNzYWdlIH0sIHsgc3RhdHVzOiA1MDAgfSk7XG5cbiAgY29uc3QgYXJ0aXN0TWFwID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcbiAgKGFydGlzdHMgYXMgQXJ0aXN0Um93W10gfCBudWxsIHwgdW5kZWZpbmVkKT8uZm9yRWFjaCgoYSkgPT4gYXJ0aXN0TWFwLnNldChhLmlkLCBhLm5hbWUpKTtcblxuICBjb25zdCB0cmFja0FydGlzdHMgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nW10+KCk7XG4gIChsaW5rcyBhcyBMaW5rUm93W10gfCBudWxsIHwgdW5kZWZpbmVkKT8uZm9yRWFjaCgobG5rKSA9PiB7XG4gICAgY29uc3QgYXJyID0gdHJhY2tBcnRpc3RzLmdldChsbmsudHJhY2tfaWQpIHx8IFtdO1xuICAgIGNvbnN0IG5tID0gYXJ0aXN0TWFwLmdldChsbmsuYXJ0aXN0X2lkKTtcbiAgICBpZiAobm0pIGFyci5wdXNoKG5tKTtcbiAgICB0cmFja0FydGlzdHMuc2V0KGxuay50cmFja19pZCwgYXJyKTtcbiAgfSk7XG5cbiAgLy8gMykgRm9yIGVhY2ggdHJhY2ssIGNhbGwgbGFzdC5mbSBhbmQgdXBkYXRlIHRoZSByb3dcbiAgbGV0IHVwZGF0ZWQgPSAwO1xuICBjb25zdCByZXN1bHRzOiBhbnlbXSA9IFtdO1xuXG4gIGZvciAoY29uc3QgdHIgb2YgdHJhY2tzIGFzIFRyYWNrUm93W10pIHtcbiAgICBsZXQgYXJ0aXN0c0ZvclRyYWNrID0gdHJhY2tBcnRpc3RzLmdldCh0ci5pZCkgfHwgW107XG4gICAgaWYgKCghYXJ0aXN0c0ZvclRyYWNrIHx8IGFydGlzdHNGb3JUcmFjay5sZW5ndGggPT09IDApICYmIHRyLmFydGlzdF9uYW1lKSB7XG4gICAgICBhcnRpc3RzRm9yVHJhY2sgPSBTdHJpbmcodHIuYXJ0aXN0X25hbWUpXG4gICAgICAgIC5zcGxpdChcIixcIilcbiAgICAgICAgLm1hcCgocykgPT4gcy50cmltKCkpXG4gICAgICAgIC5maWx0ZXIoQm9vbGVhbik7XG4gICAgfVxuICAgIGNvbnN0IGFydGlzdCA9IGFydGlzdHNGb3JUcmFja1swXSB8fCBcIlwiOyAvLyBwaWNrIHRoZSBmaXJzdCAocHJpbWFyeSkgYXJ0aXN0XG4gICAgaWYgKCFhcnRpc3QgfHwgIXRyLm5hbWUpIGNvbnRpbnVlO1xuXG4gICAgY29uc3QgdGFncyA9IGF3YWl0IGZldGNoVGFnc0ZvcihhcnRpc3QsIHRyLm5hbWUpO1xuICAgIGNvbnN0IHsgb3JkZXJlZCwgdG9wIH0gPSBzY29yZVRhZ3ModGFncyk7XG4gICAgY29uc3QgeyBlbmVyZ3ksIHZhbGVuY2UgfSA9IGRlcml2ZUVuZXJneVZhbGVuY2Uob3JkZXJlZCk7XG5cbiAgICBjb25zdCBnZW5yZV9wcmltYXJ5ID0gdG9wIHx8IHRyLmdlbnJlX3ByaW1hcnkgfHwgbnVsbDtcbiAgICBjb25zdCBnZW5yZV90YWdzID0gb3JkZXJlZC5zbGljZSgwLCA4KTtcblxuICAgIGNvbnN0IHsgZXJyb3I6IHVFcnIgfSA9IGF3YWl0IHN1cGFiYXNlQWRtaW5cbiAgICAgIC5mcm9tKFwic3BvdGlmeV90cmFja3NcIilcbiAgICAgIC51cGRhdGUoe1xuICAgICAgICBnZW5yZV9wcmltYXJ5LFxuICAgICAgICBnZW5yZV90YWdzOiBnZW5yZV90YWdzLmxlbmd0aCA/IGdlbnJlX3RhZ3MgOiBudWxsLFxuICAgICAgICBkZXJpdmVkX2VuZXJneTogZW5lcmd5LFxuICAgICAgICBkZXJpdmVkX3ZhbGVuY2U6IHZhbGVuY2UsXG4gICAgICAgIGxhc3RfZW5yaWNoZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgbWV0YV9wcm92aWRlcjoge1xuICAgICAgICAgIC4uLih0eXBlb2YgKHRyIGFzIGFueSkubWV0YV9wcm92aWRlciA9PT0gXCJvYmplY3RcIiA/ICh0ciBhcyBhbnkpLm1ldGFfcHJvdmlkZXIgOiB7fSksXG4gICAgICAgICAgbGFzdGZtOiB7IG9rOiB0cnVlLCB0YWdzRmV0Y2hlZDogdGFncy5sZW5ndGgsIGFydGlzdCwgdHJhY2s6IHRyLm5hbWUgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pXG4gICAgICAuZXEoXCJpZFwiLCB0ci5pZCk7XG5cbiAgICByZXN1bHRzLnB1c2goe1xuICAgICAgaWQ6IHRyLmlkLFxuICAgICAgdHJhY2s6IHRyLm5hbWUsXG4gICAgICBhcnRpc3QsXG4gICAgICB0b3BUYWc6IGdlbnJlX3ByaW1hcnksXG4gICAgICB0YWdDb3VudDogdGFncy5sZW5ndGgsXG4gICAgICB1cGRhdGVkOiAhdUVycixcbiAgICAgIGVycm9yOiB1RXJyPy5tZXNzYWdlIHx8IG51bGwsXG4gICAgfSk7XG5cbiAgICBpZiAoIXVFcnIpIHVwZGF0ZWQrKztcbiAgICAvLyBTbWFsbCBkZWxheSB0byBiZSBwb2xpdGUgdG8gTGFzdC5mbVxuICAgIGF3YWl0IG5ldyBQcm9taXNlKChyKSA9PiBzZXRUaW1lb3V0KHIsIDEyMCkpO1xuICB9XG5cbiAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgb2s6IHRydWUsIHVwZGF0ZWQsIHByb2Nlc3NlZDogdHJhY2tzPy5sZW5ndGggfHwgMCwgcmVzdWx0cyB9KTtcbn1cbiJdLCJuYW1lcyI6WyJOZXh0UmVzcG9uc2UiLCJzdXBhYmFzZUFkbWluIiwiTEFTVEZNX0tFWSIsInByb2Nlc3MiLCJlbnYiLCJMQVNURk1fQVBJX0tFWSIsIlRBR19BTElBUyIsImhpcGhvcCIsImxvZmkiLCJlZG0iLCJkbmIiLCJob3VzZSIsInRlY2hubyIsInRyYW5jZSIsImFtYmllbnQiLCJjaGlsbCIsInJvY2siLCJtZXRhbCIsInBvcCIsInRyYXAiLCJkYW5jZSIsIlRBR19UT19FTkVSR1kiLCJyYXZlIiwiaGFyZHN0eWxlIiwiYWNvdXN0aWMiLCJkb3dudGVtcG8iLCJUQUdfVE9fVkFMRU5DRSIsImhhcHB5IiwidXBiZWF0IiwidXBsaWZ0aW5nIiwibWVsYW5jaG9saWMiLCJzYWQiLCJkYXJrIiwiVEFHX1NUT1AiLCJTZXQiLCJub3JtYWxpemVUYWciLCJ0IiwicyIsInRyaW0iLCJ0b0xvd2VyQ2FzZSIsImNsZWFuIiwicmVwbGFjZSIsImFsaWFzIiwic2NvcmVUYWdzIiwidGFncyIsIm1hcCIsIk1hcCIsInRhZyIsIm5hbWUiLCJuIiwiaGFzIiwidyIsIk1hdGgiLCJtYXgiLCJOdW1iZXIiLCJjb3VudCIsInNldCIsImdldCIsImVudHJpZXMiLCJzb3J0IiwiYSIsImIiLCJvcmRlcmVkIiwiayIsInRvcCIsImxlbmd0aCIsImRlcml2ZUVuZXJneVZhbGVuY2UiLCJlbmVyZ3kiLCJ2YWxlbmNlIiwiZVN1bSIsImVOIiwidlN1bSIsInZOIiwidG9GaXhlZCIsImxmIiwibWV0aG9kIiwicGFyYW1zIiwidXJsIiwiVVJMIiwic2VhcmNoUGFyYW1zIiwiU3RyaW5nIiwidiIsIk9iamVjdCIsInIiLCJmZXRjaCIsInRvU3RyaW5nIiwibmV4dCIsInJldmFsaWRhdGUiLCJvayIsIkVycm9yIiwic3RhdHVzIiwianNvbiIsImZldGNoVGFnc0ZvciIsImFydGlzdCIsInRyYWNrIiwianQiLCJhdXRvY29ycmVjdCIsInRvcHRhZ3MiLCJwdXNoIiwiamEiLCJQT1NUIiwiZXJyb3IiLCJkYXRhIiwibGlzdGVucyIsImxFcnIiLCJmcm9tIiwic2VsZWN0Iiwib3JkZXIiLCJhc2NlbmRpbmciLCJsaW1pdCIsIm1lc3NhZ2UiLCJpZHMiLCJBcnJheSIsInRyYWNrX2lkIiwic2xpY2UiLCJ1cGRhdGVkIiwibm90ZSIsInRyYWNrcyIsInRFcnIiLCJsaW5rcyIsImFydGlzdHMiLCJQcm9taXNlIiwiYWxsIiwiaW4iLCJhcnRpc3RNYXAiLCJmb3JFYWNoIiwiaWQiLCJ0cmFja0FydGlzdHMiLCJsbmsiLCJhcnIiLCJubSIsImFydGlzdF9pZCIsInJlc3VsdHMiLCJ0ciIsImFydGlzdHNGb3JUcmFjayIsImFydGlzdF9uYW1lIiwic3BsaXQiLCJmaWx0ZXIiLCJCb29sZWFuIiwiZ2VucmVfcHJpbWFyeSIsImdlbnJlX3RhZ3MiLCJ1RXJyIiwidXBkYXRlIiwiZGVyaXZlZF9lbmVyZ3kiLCJkZXJpdmVkX3ZhbGVuY2UiLCJsYXN0X2VucmljaGVkX2F0IiwiRGF0ZSIsInRvSVNPU3RyaW5nIiwibWV0YV9wcm92aWRlciIsImxhc3RmbSIsInRhZ3NGZXRjaGVkIiwiZXEiLCJ0b3BUYWciLCJ0YWdDb3VudCIsInNldFRpbWVvdXQiLCJwcm9jZXNzZWQiXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./app/api/enrich/lastfm/route.ts\n");

/***/ }),

/***/ "(rsc)/./lib/supabaseAdmin.ts":
/*!******************************!*\
  !*** ./lib/supabaseAdmin.ts ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   supabaseAdmin: () => (/* binding */ supabaseAdmin),\n/* harmony export */   supabaseService: () => (/* binding */ supabaseService),\n/* harmony export */   usingServiceRole: () => (/* binding */ usingServiceRole)\n/* harmony export */ });\n/* harmony import */ var _supabase_supabase_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @supabase/supabase-js */ \"(rsc)/./node_modules/@supabase/supabase-js/dist/module/index.js\");\n// lib/supabaseAdmin.ts\n\nconst url = \"https://awxeorfppxdsygnhxlth.supabase.co\";\nconst serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n// Expose whether the service role key is configured so API routes can bail early\nconst usingServiceRole = !!(url && serviceKey);\n// Lazily create a Supabase client that uses the service role key.  This should\n// only be used in server-side code as it has full access to the database.\nfunction supabaseService() {\n    if (!usingServiceRole) {\n        throw new Error(\"SUPABASE_SERVICE_ROLE_KEY is not set\");\n    }\n    return (0,_supabase_supabase_js__WEBPACK_IMPORTED_MODULE_0__.createClient)(url, serviceKey, {\n        auth: {\n            persistSession: false,\n            autoRefreshToken: false\n        }\n    });\n}\n// Convenience singleton for callers that just need a client instance.\nconst supabaseAdmin = usingServiceRole ? supabaseService() : null;\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9saWIvc3VwYWJhc2VBZG1pbi50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUEsdUJBQXVCO0FBQzhCO0FBRXJELE1BQU1DLE1BQU1DLDBDQUFvQztBQUNoRCxNQUFNRyxhQUFhSCxRQUFRQyxHQUFHLENBQUNHLHlCQUF5QjtBQUV4RCxpRkFBaUY7QUFDMUUsTUFBTUMsbUJBQW1CLENBQUMsQ0FBRU4sQ0FBQUEsT0FBT0ksVUFBUyxFQUFHO0FBRXRELCtFQUErRTtBQUMvRSwwRUFBMEU7QUFDbkUsU0FBU0c7SUFDZCxJQUFJLENBQUNELGtCQUFrQjtRQUNyQixNQUFNLElBQUlFLE1BQU07SUFDbEI7SUFDQSxPQUFPVCxtRUFBWUEsQ0FBQ0MsS0FBTUksWUFBYTtRQUNyQ0ssTUFBTTtZQUFFQyxnQkFBZ0I7WUFBT0Msa0JBQWtCO1FBQU07SUFDekQ7QUFDRjtBQUVBLHNFQUFzRTtBQUMvRCxNQUFNQyxnQkFBZ0JOLG1CQUFtQkMsb0JBQXFCLEtBQWEiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9zb3VuZG1pbmQvLi9saWIvc3VwYWJhc2VBZG1pbi50cz8wOWQ1Il0sInNvdXJjZXNDb250ZW50IjpbIi8vIGxpYi9zdXBhYmFzZUFkbWluLnRzXG5pbXBvcnQgeyBjcmVhdGVDbGllbnQgfSBmcm9tIFwiQHN1cGFiYXNlL3N1cGFiYXNlLWpzXCI7XG5cbmNvbnN0IHVybCA9IHByb2Nlc3MuZW52Lk5FWFRfUFVCTElDX1NVUEFCQVNFX1VSTDtcbmNvbnN0IHNlcnZpY2VLZXkgPSBwcm9jZXNzLmVudi5TVVBBQkFTRV9TRVJWSUNFX1JPTEVfS0VZO1xuXG4vLyBFeHBvc2Ugd2hldGhlciB0aGUgc2VydmljZSByb2xlIGtleSBpcyBjb25maWd1cmVkIHNvIEFQSSByb3V0ZXMgY2FuIGJhaWwgZWFybHlcbmV4cG9ydCBjb25zdCB1c2luZ1NlcnZpY2VSb2xlID0gISEodXJsICYmIHNlcnZpY2VLZXkpO1xuXG4vLyBMYXppbHkgY3JlYXRlIGEgU3VwYWJhc2UgY2xpZW50IHRoYXQgdXNlcyB0aGUgc2VydmljZSByb2xlIGtleS4gIFRoaXMgc2hvdWxkXG4vLyBvbmx5IGJlIHVzZWQgaW4gc2VydmVyLXNpZGUgY29kZSBhcyBpdCBoYXMgZnVsbCBhY2Nlc3MgdG8gdGhlIGRhdGFiYXNlLlxuZXhwb3J0IGZ1bmN0aW9uIHN1cGFiYXNlU2VydmljZSgpIHtcbiAgaWYgKCF1c2luZ1NlcnZpY2VSb2xlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiU1VQQUJBU0VfU0VSVklDRV9ST0xFX0tFWSBpcyBub3Qgc2V0XCIpO1xuICB9XG4gIHJldHVybiBjcmVhdGVDbGllbnQodXJsISwgc2VydmljZUtleSEsIHtcbiAgICBhdXRoOiB7IHBlcnNpc3RTZXNzaW9uOiBmYWxzZSwgYXV0b1JlZnJlc2hUb2tlbjogZmFsc2UgfSxcbiAgfSk7XG59XG5cbi8vIENvbnZlbmllbmNlIHNpbmdsZXRvbiBmb3IgY2FsbGVycyB0aGF0IGp1c3QgbmVlZCBhIGNsaWVudCBpbnN0YW5jZS5cbmV4cG9ydCBjb25zdCBzdXBhYmFzZUFkbWluID0gdXNpbmdTZXJ2aWNlUm9sZSA/IHN1cGFiYXNlU2VydmljZSgpIDogKG51bGwgYXMgYW55KTtcbiJdLCJuYW1lcyI6WyJjcmVhdGVDbGllbnQiLCJ1cmwiLCJwcm9jZXNzIiwiZW52IiwiTkVYVF9QVUJMSUNfU1VQQUJBU0VfVVJMIiwic2VydmljZUtleSIsIlNVUEFCQVNFX1NFUlZJQ0VfUk9MRV9LRVkiLCJ1c2luZ1NlcnZpY2VSb2xlIiwic3VwYWJhc2VTZXJ2aWNlIiwiRXJyb3IiLCJhdXRoIiwicGVyc2lzdFNlc3Npb24iLCJhdXRvUmVmcmVzaFRva2VuIiwic3VwYWJhc2VBZG1pbiJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./lib/supabaseAdmin.ts\n");

/***/ })

};
;

// load runtime
var __webpack_require__ = require("../../../../webpack-runtime.js");
__webpack_require__.C(exports);
var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
var __webpack_exports__ = __webpack_require__.X(0, ["vendor-chunks/next","vendor-chunks/@supabase","vendor-chunks/tr46","vendor-chunks/whatwg-url","vendor-chunks/webidl-conversions"], () => (__webpack_exec__("(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fenrich%2Flastfm%2Froute&page=%2Fapi%2Fenrich%2Flastfm%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fenrich%2Flastfm%2Froute.ts&appDir=%2FUsers%2Fcormackerr%2FDesktop%2Fsoundmind%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Fcormackerr%2FDesktop%2Fsoundmind&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!")));
module.exports = __webpack_exports__;

})();