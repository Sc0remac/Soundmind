"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(() => {
var exports = {};
exports.id = "app/api/spotify/my/sync/route";
exports.ids = ["app/api/spotify/my/sync/route"];
exports.modules = {

/***/ "../../client/components/action-async-storage.external":
/*!*******************************************************************************!*\
  !*** external "next/dist/client/components/action-async-storage.external.js" ***!
  \*******************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/client/components/action-async-storage.external.js");

/***/ }),

/***/ "../../client/components/request-async-storage.external":
/*!********************************************************************************!*\
  !*** external "next/dist/client/components/request-async-storage.external.js" ***!
  \********************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/client/components/request-async-storage.external.js");

/***/ }),

/***/ "../../client/components/static-generation-async-storage.external":
/*!******************************************************************************************!*\
  !*** external "next/dist/client/components/static-generation-async-storage.external.js" ***!
  \******************************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/client/components/static-generation-async-storage.external.js");

/***/ }),

/***/ "next/dist/compiled/next-server/app-page.runtime.dev.js":
/*!*************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-page.runtime.dev.js" ***!
  \*************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-page.runtime.dev.js");

/***/ }),

/***/ "next/dist/compiled/next-server/app-route.runtime.dev.js":
/*!**************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-route.runtime.dev.js" ***!
  \**************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-route.runtime.dev.js");

/***/ }),

/***/ "http":
/*!***********************!*\
  !*** external "http" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("http");

/***/ }),

/***/ "https":
/*!************************!*\
  !*** external "https" ***!
  \************************/
/***/ ((module) => {

module.exports = require("https");

/***/ }),

/***/ "punycode":
/*!***************************!*\
  !*** external "punycode" ***!
  \***************************/
/***/ ((module) => {

module.exports = require("punycode");

/***/ }),

/***/ "stream":
/*!*************************!*\
  !*** external "stream" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("stream");

/***/ }),

/***/ "url":
/*!**********************!*\
  !*** external "url" ***!
  \**********************/
/***/ ((module) => {

module.exports = require("url");

/***/ }),

/***/ "zlib":
/*!***********************!*\
  !*** external "zlib" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("zlib");

/***/ }),

/***/ "(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fspotify%2Fmy%2Fsync%2Froute&page=%2Fapi%2Fspotify%2Fmy%2Fsync%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fspotify%2Fmy%2Fsync%2Froute.ts&appDir=%2FUsers%2Fcormackerr%2FDesktop%2Fsoundmind%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Fcormackerr%2FDesktop%2Fsoundmind&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!":
/*!***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fspotify%2Fmy%2Fsync%2Froute&page=%2Fapi%2Fspotify%2Fmy%2Fsync%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fspotify%2Fmy%2Fsync%2Froute.ts&appDir=%2FUsers%2Fcormackerr%2FDesktop%2Fsoundmind%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Fcormackerr%2FDesktop%2Fsoundmind&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D! ***!
  \***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   originalPathname: () => (/* binding */ originalPathname),\n/* harmony export */   patchFetch: () => (/* binding */ patchFetch),\n/* harmony export */   requestAsyncStorage: () => (/* binding */ requestAsyncStorage),\n/* harmony export */   routeModule: () => (/* binding */ routeModule),\n/* harmony export */   serverHooks: () => (/* binding */ serverHooks),\n/* harmony export */   staticGenerationAsyncStorage: () => (/* binding */ staticGenerationAsyncStorage)\n/* harmony export */ });\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/dist/server/future/route-modules/app-route/module.compiled */ \"(rsc)/./node_modules/next/dist/server/future/route-modules/app-route/module.compiled.js\");\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/dist/server/future/route-kind */ \"(rsc)/./node_modules/next/dist/server/future/route-kind.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! next/dist/server/lib/patch-fetch */ \"(rsc)/./node_modules/next/dist/server/lib/patch-fetch.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var _Users_cormackerr_Desktop_soundmind_app_api_spotify_my_sync_route_ts__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./app/api/spotify/my/sync/route.ts */ \"(rsc)/./app/api/spotify/my/sync/route.ts\");\n\n\n\n\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__.AppRouteRouteModule({\n    definition: {\n        kind: next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__.RouteKind.APP_ROUTE,\n        page: \"/api/spotify/my/sync/route\",\n        pathname: \"/api/spotify/my/sync\",\n        filename: \"route\",\n        bundlePath: \"app/api/spotify/my/sync/route\"\n    },\n    resolvedPagePath: \"/Users/cormackerr/Desktop/soundmind/app/api/spotify/my/sync/route.ts\",\n    nextConfigOutput,\n    userland: _Users_cormackerr_Desktop_soundmind_app_api_spotify_my_sync_route_ts__WEBPACK_IMPORTED_MODULE_3__\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks } = routeModule;\nconst originalPathname = \"/api/spotify/my/sync/route\";\nfunction patchFetch() {\n    return (0,next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__.patchFetch)({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\n\n\n//# sourceMappingURL=app-route.js.map//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9ub2RlX21vZHVsZXMvbmV4dC9kaXN0L2J1aWxkL3dlYnBhY2svbG9hZGVycy9uZXh0LWFwcC1sb2FkZXIuanM/bmFtZT1hcHAlMkZhcGklMkZzcG90aWZ5JTJGbXklMkZzeW5jJTJGcm91dGUmcGFnZT0lMkZhcGklMkZzcG90aWZ5JTJGbXklMkZzeW5jJTJGcm91dGUmYXBwUGF0aHM9JnBhZ2VQYXRoPXByaXZhdGUtbmV4dC1hcHAtZGlyJTJGYXBpJTJGc3BvdGlmeSUyRm15JTJGc3luYyUyRnJvdXRlLnRzJmFwcERpcj0lMkZVc2VycyUyRmNvcm1hY2tlcnIlMkZEZXNrdG9wJTJGc291bmRtaW5kJTJGYXBwJnBhZ2VFeHRlbnNpb25zPXRzeCZwYWdlRXh0ZW5zaW9ucz10cyZwYWdlRXh0ZW5zaW9ucz1qc3gmcGFnZUV4dGVuc2lvbnM9anMmcm9vdERpcj0lMkZVc2VycyUyRmNvcm1hY2tlcnIlMkZEZXNrdG9wJTJGc291bmRtaW5kJmlzRGV2PXRydWUmdHNjb25maWdQYXRoPXRzY29uZmlnLmpzb24mYmFzZVBhdGg9JmFzc2V0UHJlZml4PSZuZXh0Q29uZmlnT3V0cHV0PSZwcmVmZXJyZWRSZWdpb249Jm1pZGRsZXdhcmVDb25maWc9ZTMwJTNEISIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7QUFBc0c7QUFDdkM7QUFDYztBQUNvQjtBQUNqRztBQUNBO0FBQ0E7QUFDQSx3QkFBd0IsZ0hBQW1CO0FBQzNDO0FBQ0EsY0FBYyx5RUFBUztBQUN2QjtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsWUFBWTtBQUNaLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQSxRQUFRLGlFQUFpRTtBQUN6RTtBQUNBO0FBQ0EsV0FBVyw0RUFBVztBQUN0QjtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ3VIOztBQUV2SCIsInNvdXJjZXMiOlsid2VicGFjazovL3NvdW5kbWluZC8/NDAyMCJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHBSb3V0ZVJvdXRlTW9kdWxlIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvZnV0dXJlL3JvdXRlLW1vZHVsZXMvYXBwLXJvdXRlL21vZHVsZS5jb21waWxlZFwiO1xuaW1wb3J0IHsgUm91dGVLaW5kIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvZnV0dXJlL3JvdXRlLWtpbmRcIjtcbmltcG9ydCB7IHBhdGNoRmV0Y2ggYXMgX3BhdGNoRmV0Y2ggfSBmcm9tIFwibmV4dC9kaXN0L3NlcnZlci9saWIvcGF0Y2gtZmV0Y2hcIjtcbmltcG9ydCAqIGFzIHVzZXJsYW5kIGZyb20gXCIvVXNlcnMvY29ybWFja2Vyci9EZXNrdG9wL3NvdW5kbWluZC9hcHAvYXBpL3Nwb3RpZnkvbXkvc3luYy9yb3V0ZS50c1wiO1xuLy8gV2UgaW5qZWN0IHRoZSBuZXh0Q29uZmlnT3V0cHV0IGhlcmUgc28gdGhhdCB3ZSBjYW4gdXNlIHRoZW0gaW4gdGhlIHJvdXRlXG4vLyBtb2R1bGUuXG5jb25zdCBuZXh0Q29uZmlnT3V0cHV0ID0gXCJcIlxuY29uc3Qgcm91dGVNb2R1bGUgPSBuZXcgQXBwUm91dGVSb3V0ZU1vZHVsZSh7XG4gICAgZGVmaW5pdGlvbjoge1xuICAgICAgICBraW5kOiBSb3V0ZUtpbmQuQVBQX1JPVVRFLFxuICAgICAgICBwYWdlOiBcIi9hcGkvc3BvdGlmeS9teS9zeW5jL3JvdXRlXCIsXG4gICAgICAgIHBhdGhuYW1lOiBcIi9hcGkvc3BvdGlmeS9teS9zeW5jXCIsXG4gICAgICAgIGZpbGVuYW1lOiBcInJvdXRlXCIsXG4gICAgICAgIGJ1bmRsZVBhdGg6IFwiYXBwL2FwaS9zcG90aWZ5L215L3N5bmMvcm91dGVcIlxuICAgIH0sXG4gICAgcmVzb2x2ZWRQYWdlUGF0aDogXCIvVXNlcnMvY29ybWFja2Vyci9EZXNrdG9wL3NvdW5kbWluZC9hcHAvYXBpL3Nwb3RpZnkvbXkvc3luYy9yb3V0ZS50c1wiLFxuICAgIG5leHRDb25maWdPdXRwdXQsXG4gICAgdXNlcmxhbmRcbn0pO1xuLy8gUHVsbCBvdXQgdGhlIGV4cG9ydHMgdGhhdCB3ZSBuZWVkIHRvIGV4cG9zZSBmcm9tIHRoZSBtb2R1bGUuIFRoaXMgc2hvdWxkXG4vLyBiZSBlbGltaW5hdGVkIHdoZW4gd2UndmUgbW92ZWQgdGhlIG90aGVyIHJvdXRlcyB0byB0aGUgbmV3IGZvcm1hdC4gVGhlc2Vcbi8vIGFyZSB1c2VkIHRvIGhvb2sgaW50byB0aGUgcm91dGUuXG5jb25zdCB7IHJlcXVlc3RBc3luY1N0b3JhZ2UsIHN0YXRpY0dlbmVyYXRpb25Bc3luY1N0b3JhZ2UsIHNlcnZlckhvb2tzIH0gPSByb3V0ZU1vZHVsZTtcbmNvbnN0IG9yaWdpbmFsUGF0aG5hbWUgPSBcIi9hcGkvc3BvdGlmeS9teS9zeW5jL3JvdXRlXCI7XG5mdW5jdGlvbiBwYXRjaEZldGNoKCkge1xuICAgIHJldHVybiBfcGF0Y2hGZXRjaCh7XG4gICAgICAgIHNlcnZlckhvb2tzLFxuICAgICAgICBzdGF0aWNHZW5lcmF0aW9uQXN5bmNTdG9yYWdlXG4gICAgfSk7XG59XG5leHBvcnQgeyByb3V0ZU1vZHVsZSwgcmVxdWVzdEFzeW5jU3RvcmFnZSwgc3RhdGljR2VuZXJhdGlvbkFzeW5jU3RvcmFnZSwgc2VydmVySG9va3MsIG9yaWdpbmFsUGF0aG5hbWUsIHBhdGNoRmV0Y2gsICB9O1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1hcHAtcm91dGUuanMubWFwIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fspotify%2Fmy%2Fsync%2Froute&page=%2Fapi%2Fspotify%2Fmy%2Fsync%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fspotify%2Fmy%2Fsync%2Froute.ts&appDir=%2FUsers%2Fcormackerr%2FDesktop%2Fsoundmind%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Fcormackerr%2FDesktop%2Fsoundmind&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!\n");

/***/ }),

/***/ "(rsc)/./app/api/spotify/my/sync/route.ts":
/*!******************************************!*\
  !*** ./app/api/spotify/my/sync/route.ts ***!
  \******************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   POST: () => (/* binding */ POST)\n/* harmony export */ });\n/* harmony import */ var next_server__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/server */ \"(rsc)/./node_modules/next/dist/api/server.js\");\n/* harmony import */ var next_headers__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/headers */ \"(rsc)/./node_modules/next/dist/api/headers.js\");\n/* harmony import */ var _supabase_supabase_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! @supabase/supabase-js */ \"(rsc)/./node_modules/@supabase/supabase-js/dist/module/index.js\");\n/* harmony import */ var _lib_supabaseAdmin__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! @/lib/supabaseAdmin */ \"(rsc)/./lib/supabaseAdmin.ts\");\n// app/api/spotify/my/sync/route.ts\n\n\n\n\nfunction getBearer() {\n    const h = (0,next_headers__WEBPACK_IMPORTED_MODULE_1__.headers)();\n    const a = h.get(\"authorization\") || h.get(\"Authorization\") || \"\";\n    const m = a.match(/^Bearer\\s+(.+)$/i);\n    return m ? m[1] : null;\n}\nasync function POST(req) {\n    try {\n        const url = new URL(req.url);\n        const full = url.searchParams.get(\"full\") === \"1\";\n        // 1) Identify the user with a user-scoped client\n        const bearer = getBearer();\n        if (!bearer) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: \"Missing bearer\"\n        }, {\n            status: 401\n        });\n        const userClient = (0,_supabase_supabase_js__WEBPACK_IMPORTED_MODULE_3__.createClient)(\"https://awxeorfppxdsygnhxlth.supabase.co\", \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3eGVvcmZwcHhkc3lnbmh4bHRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2MTExOTUsImV4cCI6MjA3MDE4NzE5NX0.62qbnPYJc-UKAYiedhe9EhMcTTgO5iX6RniGKGr6rtk\", {\n            global: {\n                headers: {\n                    Authorization: `Bearer ${bearer}`\n                }\n            },\n            auth: {\n                persistSession: false\n            }\n        });\n        const { data: u, error: uErr } = await userClient.auth.getUser();\n        if (uErr || !u?.user) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: uErr?.message || \"No user\"\n        }, {\n            status: 401\n        });\n        const userId = u.user.id;\n        // 2) Read tokens with ADMIN client (bypass RLS)\n        const { data: acct, error: acctErr } = await _lib_supabaseAdmin__WEBPACK_IMPORTED_MODULE_2__.supabaseAdmin.from(\"spotify_accounts\").select(\"access_token, refresh_token, expires_at\").eq(\"user_id\", userId).maybeSingle();\n        if (acctErr || !acct) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: acctErr?.message || \"No Spotify account\"\n            }, {\n                status: 400\n            });\n        }\n        let accessToken = acct.access_token;\n        const refreshToken = acct.refresh_token;\n        const exp = acct.expires_at ? new Date(acct.expires_at).getTime() : 0;\n        // 3) Refresh if expiring\n        if (!accessToken || exp - Date.now() < 60000) {\n            const base = process.env.APP_BASE_URL || \"http://127.0.0.1:3000\";\n            const redirect = process.env.SPOTIFY_REDIRECT_URI || `${base}/api/spotify/callback`;\n            const resp = await fetch(\"https://accounts.spotify.com/api/token\", {\n                method: \"POST\",\n                headers: {\n                    \"Content-Type\": \"application/x-www-form-urlencoded\",\n                    Authorization: \"Basic \" + Buffer.from(`${process.env.SPOTIFY_CLIENT_ID}:${process.env.SPOTIFY_CLIENT_SECRET}`).toString(\"base64\")\n                },\n                body: new URLSearchParams({\n                    grant_type: \"refresh_token\",\n                    refresh_token: refreshToken,\n                    redirect_uri: redirect\n                })\n            });\n            if (!resp.ok) {\n                const text = await resp.text();\n                return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                    error: \"Refresh failed\",\n                    text\n                }, {\n                    status: 400\n                });\n            }\n            const t = await resp.json();\n            accessToken = t.access_token;\n            const newExp = new Date(Date.now() + Math.max(0, (t.expires_in ?? 3600) - 60) * 1000);\n            await _lib_supabaseAdmin__WEBPACK_IMPORTED_MODULE_2__.supabaseAdmin.from(\"spotify_accounts\").update({\n                access_token: accessToken,\n                refresh_token: t.refresh_token ?? refreshToken,\n                expires_at: newExp.toISOString()\n            }).eq(\"user_id\", userId);\n        }\n        // 4) Windowing\n        let afterParam = \"\";\n        if (!full) {\n            const { data: last } = await _lib_supabaseAdmin__WEBPACK_IMPORTED_MODULE_2__.supabaseAdmin.from(\"spotify_listens\").select(\"played_at\").eq(\"user_id\", userId).order(\"played_at\", {\n                ascending: false\n            }).limit(1).maybeSingle();\n            if (last?.played_at) afterParam = `&after=${new Date(last.played_at).getTime() + 1}`;\n        }\n        // 5) Fetch recently played\n        const apiUrl = `https://api.spotify.com/v1/me/player/recently-played?limit=50${afterParam}`;\n        const spRes = await fetch(apiUrl, {\n            headers: {\n                Authorization: `Bearer ${accessToken}`\n            }\n        });\n        if (!spRes.ok) {\n            const text = await spRes.text();\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: \"Spotify API error\",\n                status: spRes.status,\n                text\n            }, {\n                status: 400\n            });\n        }\n        const payload = await spRes.json();\n        const items = Array.isArray(payload.items) ? payload.items : [];\n        if (!items.length) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            ok: true,\n            items_received: 0,\n            imported: 0\n        });\n        // 6) Build rows\n        const trackMap = new Map();\n        const listenMap = new Map();\n        const artistMap = new Map();\n        const trackArtistSet = new Set();\n        const trackArtistRows = [];\n        for (const it of items){\n            const tr = it?.track;\n            if (!tr?.id) continue;\n            // Track row (dedupe by id)\n            if (!trackMap.has(tr.id)) {\n                const artistName = Array.isArray(tr.artists) ? tr.artists.map((a)=>a?.name).filter(Boolean).join(\", \") : null;\n                const img = tr.album?.images?.[0]?.url || null;\n                trackMap.set(tr.id, {\n                    id: tr.id,\n                    name: tr.name ?? null,\n                    artist_name: artistName,\n                    album_image_url: img,\n                    preview_url: tr.preview_url ?? null\n                });\n            }\n            // Artist + link rows\n            if (Array.isArray(tr.artists)) {\n                for (const a of tr.artists){\n                    if (!a?.id) continue;\n                    if (!artistMap.has(a.id)) {\n                        artistMap.set(a.id, {\n                            id: a.id,\n                            name: a.name ?? \"\"\n                        });\n                    }\n                    const key = `${tr.id}:${a.id}`;\n                    if (!trackArtistSet.has(key)) {\n                        trackArtistSet.add(key);\n                        trackArtistRows.push({\n                            track_id: tr.id,\n                            artist_id: a.id\n                        });\n                    }\n                }\n            }\n            // Listen row (dedupe by composite key)\n            const playedAtIso = it.played_at ? new Date(it.played_at).toISOString() : null;\n            if (playedAtIso) {\n                const key = `${userId}:${tr.id}:${playedAtIso}`;\n                if (!listenMap.has(key)) {\n                    listenMap.set(key, {\n                        user_id: userId,\n                        track_id: tr.id,\n                        played_at: playedAtIso\n                    });\n                }\n            }\n        }\n        const tracks = Array.from(trackMap.values());\n        const listens = Array.from(listenMap.values());\n        const artists = Array.from(artistMap.values());\n        const trackArtists = trackArtistRows;\n        // 7) Write with ADMIN client (bypass RLS) — unique rows only\n        const { error: trErr } = await _lib_supabaseAdmin__WEBPACK_IMPORTED_MODULE_2__.supabaseAdmin.from(\"spotify_tracks\").upsert(tracks, {\n            onConflict: \"id\"\n        }); // safe because we deduped\n        if (trErr) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: trErr.message,\n            where: \"tracks.upsert\"\n        }, {\n            status: 400\n        });\n        const { error: arErr } = await _lib_supabaseAdmin__WEBPACK_IMPORTED_MODULE_2__.supabaseAdmin.from(\"spotify_artists\").upsert(artists, {\n            onConflict: \"id\"\n        });\n        if (arErr) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: arErr.message,\n            where: \"artists.upsert\"\n        }, {\n            status: 400\n        });\n        const { error: taErr } = await _lib_supabaseAdmin__WEBPACK_IMPORTED_MODULE_2__.supabaseAdmin.from(\"spotify_track_artists\").upsert(trackArtists, {\n            onConflict: \"track_id,artist_id\"\n        });\n        if (taErr) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: taErr.message,\n            where: \"track_artists.upsert\"\n        }, {\n            status: 400\n        });\n        const { error: lsErr } = await _lib_supabaseAdmin__WEBPACK_IMPORTED_MODULE_2__.supabaseAdmin.from(\"spotify_listens\").upsert(listens, {\n            onConflict: \"user_id,track_id,played_at\"\n        });\n        if (lsErr) return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: lsErr.message,\n            where: \"listens.upsert\"\n        }, {\n            status: 400\n        });\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            ok: true,\n            apiUrl,\n            items_received: items.length,\n            imported: listens.length\n        });\n    } catch (e) {\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: e?.message || String(e)\n        }, {\n            status: 500\n        });\n    }\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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WUFBRS9HLFFBQVE7UUFBSTtRQUVyRyxNQUFNLEVBQUVELE9BQU9rSCxLQUFLLEVBQUUsR0FBRyxNQUFNakksNkRBQWFBLENBQ3pDb0MsSUFBSSxDQUFDLHlCQUNMeUYsTUFBTSxDQUFDRixjQUFjO1lBQUVHLFlBQVk7UUFBcUI7UUFDM0QsSUFBSUcsT0FBTyxPQUFPcEkscURBQVlBLENBQUNpQixJQUFJLENBQUM7WUFBRUMsT0FBT2tILE1BQU1sRyxPQUFPO1lBQUVnRyxPQUFPO1FBQXVCLEdBQUc7WUFBRS9HLFFBQVE7UUFBSTtRQUUzRyxNQUFNLEVBQUVELE9BQU9tSCxLQUFLLEVBQUUsR0FBRyxNQUFNbEksNkRBQWFBLENBQ3pDb0MsSUFBSSxDQUFDLG1CQUNMeUYsTUFBTSxDQUFDSCxTQUFTO1lBQUVJLFlBQVk7UUFBNkI7UUFDOUQsSUFBSUksT0FBTyxPQUFPckkscURBQVlBLENBQUNpQixJQUFJLENBQUM7WUFBRUMsT0FBT21ILE1BQU1uRyxPQUFPO1lBQUVnRyxPQUFPO1FBQWlCLEdBQUc7WUFBRS9HLFFBQVE7UUFBSTtRQUVyRyxPQUFPbkIscURBQVlBLENBQUNpQixJQUFJLENBQUM7WUFDdkJrRCxJQUFJO1lBQ0plO1lBQ0FPLGdCQUFnQkosTUFBTUcsTUFBTTtZQUM1QkUsVUFBVW1DLFFBQVFyQyxNQUFNO1FBQzFCO0lBQ0YsRUFBRSxPQUFPOEMsR0FBUTtRQUNmLE9BQU90SSxxREFBWUEsQ0FBQ2lCLElBQUksQ0FBQztZQUFFQyxPQUFPb0gsR0FBR3BHLFdBQVdxRyxPQUFPRDtRQUFHLEdBQUc7WUFBRW5ILFFBQVE7UUFBSTtJQUM3RTtBQUNGIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vc291bmRtaW5kLy4vYXBwL2FwaS9zcG90aWZ5L215L3N5bmMvcm91dGUudHM/YmM4NSJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBhcHAvYXBpL3Nwb3RpZnkvbXkvc3luYy9yb3V0ZS50c1xuaW1wb3J0IHsgTmV4dFJlc3BvbnNlIH0gZnJvbSBcIm5leHQvc2VydmVyXCI7XG5pbXBvcnQgeyBoZWFkZXJzIH0gZnJvbSBcIm5leHQvaGVhZGVyc1wiO1xuaW1wb3J0IHsgY3JlYXRlQ2xpZW50IH0gZnJvbSBcIkBzdXBhYmFzZS9zdXBhYmFzZS1qc1wiO1xuaW1wb3J0IHsgc3VwYWJhc2VBZG1pbiB9IGZyb20gXCJAL2xpYi9zdXBhYmFzZUFkbWluXCI7XG5cbmZ1bmN0aW9uIGdldEJlYXJlcigpIHtcbiAgY29uc3QgaCA9IGhlYWRlcnMoKTtcbiAgY29uc3QgYSA9IGguZ2V0KFwiYXV0aG9yaXphdGlvblwiKSB8fCBoLmdldChcIkF1dGhvcml6YXRpb25cIikgfHwgXCJcIjtcbiAgY29uc3QgbSA9IGEubWF0Y2goL15CZWFyZXJcXHMrKC4rKSQvaSk7XG4gIHJldHVybiBtID8gbVsxXSA6IG51bGw7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBQT1NUKHJlcTogUmVxdWVzdCkge1xuICB0cnkge1xuICAgIGNvbnN0IHVybCA9IG5ldyBVUkwocmVxLnVybCk7XG4gICAgY29uc3QgZnVsbCA9IHVybC5zZWFyY2hQYXJhbXMuZ2V0KFwiZnVsbFwiKSA9PT0gXCIxXCI7XG5cbiAgICAvLyAxKSBJZGVudGlmeSB0aGUgdXNlciB3aXRoIGEgdXNlci1zY29wZWQgY2xpZW50XG4gICAgY29uc3QgYmVhcmVyID0gZ2V0QmVhcmVyKCk7XG4gICAgaWYgKCFiZWFyZXIpIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiBcIk1pc3NpbmcgYmVhcmVyXCIgfSwgeyBzdGF0dXM6IDQwMSB9KTtcblxuICAgIGNvbnN0IHVzZXJDbGllbnQgPSBjcmVhdGVDbGllbnQoXG4gICAgICBwcm9jZXNzLmVudi5ORVhUX1BVQkxJQ19TVVBBQkFTRV9VUkwhLFxuICAgICAgcHJvY2Vzcy5lbnYuTkVYVF9QVUJMSUNfU1VQQUJBU0VfQU5PTl9LRVkhLFxuICAgICAgeyBnbG9iYWw6IHsgaGVhZGVyczogeyBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7YmVhcmVyfWAgfSB9LCBhdXRoOiB7IHBlcnNpc3RTZXNzaW9uOiBmYWxzZSB9IH1cbiAgICApO1xuICAgIGNvbnN0IHsgZGF0YTogdSwgZXJyb3I6IHVFcnIgfSA9IGF3YWl0IHVzZXJDbGllbnQuYXV0aC5nZXRVc2VyKCk7XG4gICAgaWYgKHVFcnIgfHwgIXU/LnVzZXIpIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiB1RXJyPy5tZXNzYWdlIHx8IFwiTm8gdXNlclwiIH0sIHsgc3RhdHVzOiA0MDEgfSk7XG4gICAgY29uc3QgdXNlcklkID0gdS51c2VyLmlkO1xuXG4gICAgLy8gMikgUmVhZCB0b2tlbnMgd2l0aCBBRE1JTiBjbGllbnQgKGJ5cGFzcyBSTFMpXG4gICAgY29uc3QgeyBkYXRhOiBhY2N0LCBlcnJvcjogYWNjdEVyciB9ID0gYXdhaXQgc3VwYWJhc2VBZG1pblxuICAgICAgLmZyb20oXCJzcG90aWZ5X2FjY291bnRzXCIpXG4gICAgICAuc2VsZWN0KFwiYWNjZXNzX3Rva2VuLCByZWZyZXNoX3Rva2VuLCBleHBpcmVzX2F0XCIpXG4gICAgICAuZXEoXCJ1c2VyX2lkXCIsIHVzZXJJZClcbiAgICAgIC5tYXliZVNpbmdsZSgpO1xuXG4gICAgaWYgKGFjY3RFcnIgfHwgIWFjY3QpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiBhY2N0RXJyPy5tZXNzYWdlIHx8IFwiTm8gU3BvdGlmeSBhY2NvdW50XCIgfSwgeyBzdGF0dXM6IDQwMCB9KTtcbiAgICB9XG5cbiAgICBsZXQgYWNjZXNzVG9rZW4gPSBhY2N0LmFjY2Vzc190b2tlbiBhcyBzdHJpbmc7XG4gICAgY29uc3QgcmVmcmVzaFRva2VuID0gYWNjdC5yZWZyZXNoX3Rva2VuIGFzIHN0cmluZztcbiAgICBjb25zdCBleHAgPSBhY2N0LmV4cGlyZXNfYXQgPyBuZXcgRGF0ZShhY2N0LmV4cGlyZXNfYXQpLmdldFRpbWUoKSA6IDA7XG5cbiAgICAvLyAzKSBSZWZyZXNoIGlmIGV4cGlyaW5nXG4gICAgaWYgKCFhY2Nlc3NUb2tlbiB8fCBleHAgLSBEYXRlLm5vdygpIDwgNjBfMDAwKSB7XG4gICAgICBjb25zdCBiYXNlID0gcHJvY2Vzcy5lbnYuQVBQX0JBU0VfVVJMIHx8IFwiaHR0cDovLzEyNy4wLjAuMTozMDAwXCI7XG4gICAgICBjb25zdCByZWRpcmVjdCA9IHByb2Nlc3MuZW52LlNQT1RJRllfUkVESVJFQ1RfVVJJIHx8IGAke2Jhc2V9L2FwaS9zcG90aWZ5L2NhbGxiYWNrYDtcblxuICAgICAgY29uc3QgcmVzcCA9IGF3YWl0IGZldGNoKFwiaHR0cHM6Ly9hY2NvdW50cy5zcG90aWZ5LmNvbS9hcGkvdG9rZW5cIiwge1xuICAgICAgICBtZXRob2Q6IFwiUE9TVFwiLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRcIixcbiAgICAgICAgICBBdXRob3JpemF0aW9uOlxuICAgICAgICAgICAgXCJCYXNpYyBcIiArXG4gICAgICAgICAgICBCdWZmZXIuZnJvbShcbiAgICAgICAgICAgICAgYCR7cHJvY2Vzcy5lbnYuU1BPVElGWV9DTElFTlRfSUR9OiR7cHJvY2Vzcy5lbnYuU1BPVElGWV9DTElFTlRfU0VDUkVUfWBcbiAgICAgICAgICAgICkudG9TdHJpbmcoXCJiYXNlNjRcIiksXG4gICAgICAgIH0sXG4gICAgICAgIGJvZHk6IG5ldyBVUkxTZWFyY2hQYXJhbXMoe1xuICAgICAgICAgIGdyYW50X3R5cGU6IFwicmVmcmVzaF90b2tlblwiLFxuICAgICAgICAgIHJlZnJlc2hfdG9rZW46IHJlZnJlc2hUb2tlbixcbiAgICAgICAgICByZWRpcmVjdF91cmk6IHJlZGlyZWN0LFxuICAgICAgICB9KSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXJlc3Aub2spIHtcbiAgICAgICAgY29uc3QgdGV4dCA9IGF3YWl0IHJlc3AudGV4dCgpO1xuICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogXCJSZWZyZXNoIGZhaWxlZFwiLCB0ZXh0IH0sIHsgc3RhdHVzOiA0MDAgfSk7XG4gICAgICB9XG4gICAgICBjb25zdCB0ID0gYXdhaXQgcmVzcC5qc29uKCk7XG4gICAgICBhY2Nlc3NUb2tlbiA9IHQuYWNjZXNzX3Rva2VuO1xuICAgICAgY29uc3QgbmV3RXhwID0gbmV3IERhdGUoRGF0ZS5ub3coKSArIE1hdGgubWF4KDAsICh0LmV4cGlyZXNfaW4gPz8gMzYwMCkgLSA2MCkgKiAxMDAwKTtcblxuICAgICAgYXdhaXQgc3VwYWJhc2VBZG1pblxuICAgICAgICAuZnJvbShcInNwb3RpZnlfYWNjb3VudHNcIilcbiAgICAgICAgLnVwZGF0ZSh7XG4gICAgICAgICAgYWNjZXNzX3Rva2VuOiBhY2Nlc3NUb2tlbixcbiAgICAgICAgICByZWZyZXNoX3Rva2VuOiB0LnJlZnJlc2hfdG9rZW4gPz8gcmVmcmVzaFRva2VuLFxuICAgICAgICAgIGV4cGlyZXNfYXQ6IG5ld0V4cC50b0lTT1N0cmluZygpLFxuICAgICAgICB9KVxuICAgICAgICAuZXEoXCJ1c2VyX2lkXCIsIHVzZXJJZCk7XG4gICAgfVxuXG4gICAgLy8gNCkgV2luZG93aW5nXG4gICAgbGV0IGFmdGVyUGFyYW0gPSBcIlwiO1xuICAgIGlmICghZnVsbCkge1xuICAgICAgY29uc3QgeyBkYXRhOiBsYXN0IH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXG4gICAgICAgIC5mcm9tKFwic3BvdGlmeV9saXN0ZW5zXCIpXG4gICAgICAgIC5zZWxlY3QoXCJwbGF5ZWRfYXRcIilcbiAgICAgICAgLmVxKFwidXNlcl9pZFwiLCB1c2VySWQpXG4gICAgICAgIC5vcmRlcihcInBsYXllZF9hdFwiLCB7IGFzY2VuZGluZzogZmFsc2UgfSlcbiAgICAgICAgLmxpbWl0KDEpXG4gICAgICAgIC5tYXliZVNpbmdsZSgpO1xuXG4gICAgICBpZiAobGFzdD8ucGxheWVkX2F0KSBhZnRlclBhcmFtID0gYCZhZnRlcj0ke25ldyBEYXRlKGxhc3QucGxheWVkX2F0KS5nZXRUaW1lKCkgKyAxfWA7XG4gICAgfVxuXG4gICAgLy8gNSkgRmV0Y2ggcmVjZW50bHkgcGxheWVkXG4gICAgY29uc3QgYXBpVXJsID0gYGh0dHBzOi8vYXBpLnNwb3RpZnkuY29tL3YxL21lL3BsYXllci9yZWNlbnRseS1wbGF5ZWQ/bGltaXQ9NTAke2FmdGVyUGFyYW19YDtcbiAgICBjb25zdCBzcFJlcyA9IGF3YWl0IGZldGNoKGFwaVVybCwgeyBoZWFkZXJzOiB7IEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHthY2Nlc3NUb2tlbn1gIH0gfSk7XG4gICAgaWYgKCFzcFJlcy5vaykge1xuICAgICAgY29uc3QgdGV4dCA9IGF3YWl0IHNwUmVzLnRleHQoKTtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiBcIlNwb3RpZnkgQVBJIGVycm9yXCIsIHN0YXR1czogc3BSZXMuc3RhdHVzLCB0ZXh0IH0sIHsgc3RhdHVzOiA0MDAgfSk7XG4gICAgfVxuICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCBzcFJlcy5qc29uKCk7XG4gICAgY29uc3QgaXRlbXMgPSBBcnJheS5pc0FycmF5KHBheWxvYWQuaXRlbXMpID8gcGF5bG9hZC5pdGVtcyA6IFtdO1xuICAgIGlmICghaXRlbXMubGVuZ3RoKSByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBvazogdHJ1ZSwgaXRlbXNfcmVjZWl2ZWQ6IDAsIGltcG9ydGVkOiAwIH0pO1xuXG4gICAgdHlwZSBUcmFja1JvdyA9IHtcbiAgICAgIGlkOiBzdHJpbmc7XG4gICAgICBuYW1lOiBzdHJpbmcgfCBudWxsO1xuICAgICAgYXJ0aXN0X25hbWU6IHN0cmluZyB8IG51bGw7XG4gICAgICBhbGJ1bV9pbWFnZV91cmw6IHN0cmluZyB8IG51bGw7XG4gICAgICBwcmV2aWV3X3VybDogc3RyaW5nIHwgbnVsbDtcbiAgICB9O1xuXG4gICAgdHlwZSBBcnRpc3RSb3cgPSB7IGlkOiBzdHJpbmc7IG5hbWU6IHN0cmluZyB9O1xuICAgIHR5cGUgVHJhY2tBcnRpc3RSb3cgPSB7IHRyYWNrX2lkOiBzdHJpbmc7IGFydGlzdF9pZDogc3RyaW5nIH07XG5cbiAgICAvLyA2KSBCdWlsZCByb3dzXG4gICAgY29uc3QgdHJhY2tNYXAgPSBuZXcgTWFwPHN0cmluZywgVHJhY2tSb3c+KCk7XG4gICAgY29uc3QgbGlzdGVuTWFwID0gbmV3IE1hcDxzdHJpbmcsIHsgdXNlcl9pZDogc3RyaW5nOyB0cmFja19pZDogc3RyaW5nOyBwbGF5ZWRfYXQ6IHN0cmluZyB9PigpO1xuICAgIGNvbnN0IGFydGlzdE1hcCA9IG5ldyBNYXA8c3RyaW5nLCBBcnRpc3RSb3c+KCk7XG4gICAgY29uc3QgdHJhY2tBcnRpc3RTZXQgPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgICBjb25zdCB0cmFja0FydGlzdFJvd3M6IFRyYWNrQXJ0aXN0Um93W10gPSBbXTtcblxuICAgIGZvciAoY29uc3QgaXQgb2YgaXRlbXMpIHtcbiAgICAgIGNvbnN0IHRyID0gaXQ/LnRyYWNrO1xuICAgICAgaWYgKCF0cj8uaWQpIGNvbnRpbnVlO1xuXG4gICAgICAvLyBUcmFjayByb3cgKGRlZHVwZSBieSBpZClcbiAgICAgIGlmICghdHJhY2tNYXAuaGFzKHRyLmlkKSkge1xuICAgICAgICBjb25zdCBhcnRpc3ROYW1lID0gQXJyYXkuaXNBcnJheSh0ci5hcnRpc3RzKVxuICAgICAgICAgID8gdHIuYXJ0aXN0cy5tYXAoKGE6IGFueSkgPT4gYT8ubmFtZSkuZmlsdGVyKEJvb2xlYW4pLmpvaW4oXCIsIFwiKVxuICAgICAgICAgIDogbnVsbDtcbiAgICAgICAgY29uc3QgaW1nID0gdHIuYWxidW0/LmltYWdlcz8uWzBdPy51cmwgfHwgbnVsbDtcblxuICAgICAgICB0cmFja01hcC5zZXQodHIuaWQsIHtcbiAgICAgICAgICBpZDogdHIuaWQsXG4gICAgICAgICAgbmFtZTogdHIubmFtZSA/PyBudWxsLFxuICAgICAgICAgIGFydGlzdF9uYW1lOiBhcnRpc3ROYW1lLFxuICAgICAgICAgIGFsYnVtX2ltYWdlX3VybDogaW1nLFxuICAgICAgICAgIHByZXZpZXdfdXJsOiB0ci5wcmV2aWV3X3VybCA/PyBudWxsLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gQXJ0aXN0ICsgbGluayByb3dzXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheSh0ci5hcnRpc3RzKSkge1xuICAgICAgICBmb3IgKGNvbnN0IGEgb2YgdHIuYXJ0aXN0cykge1xuICAgICAgICAgIGlmICghYT8uaWQpIGNvbnRpbnVlO1xuICAgICAgICAgIGlmICghYXJ0aXN0TWFwLmhhcyhhLmlkKSkge1xuICAgICAgICAgICAgYXJ0aXN0TWFwLnNldChhLmlkLCB7IGlkOiBhLmlkLCBuYW1lOiBhLm5hbWUgPz8gXCJcIiB9KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3Qga2V5ID0gYCR7dHIuaWR9OiR7YS5pZH1gO1xuICAgICAgICAgIGlmICghdHJhY2tBcnRpc3RTZXQuaGFzKGtleSkpIHtcbiAgICAgICAgICAgIHRyYWNrQXJ0aXN0U2V0LmFkZChrZXkpO1xuICAgICAgICAgICAgdHJhY2tBcnRpc3RSb3dzLnB1c2goeyB0cmFja19pZDogdHIuaWQsIGFydGlzdF9pZDogYS5pZCB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gTGlzdGVuIHJvdyAoZGVkdXBlIGJ5IGNvbXBvc2l0ZSBrZXkpXG4gICAgICBjb25zdCBwbGF5ZWRBdElzbyA9IGl0LnBsYXllZF9hdCA/IG5ldyBEYXRlKGl0LnBsYXllZF9hdCkudG9JU09TdHJpbmcoKSA6IG51bGw7XG4gICAgICBpZiAocGxheWVkQXRJc28pIHtcbiAgICAgICAgY29uc3Qga2V5ID0gYCR7dXNlcklkfToke3RyLmlkfToke3BsYXllZEF0SXNvfWA7XG4gICAgICAgIGlmICghbGlzdGVuTWFwLmhhcyhrZXkpKSB7XG4gICAgICAgICAgbGlzdGVuTWFwLnNldChrZXksIHsgdXNlcl9pZDogdXNlcklkLCB0cmFja19pZDogdHIuaWQsIHBsYXllZF9hdDogcGxheWVkQXRJc28gfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCB0cmFja3MgPSBBcnJheS5mcm9tKHRyYWNrTWFwLnZhbHVlcygpKTtcbiAgICBjb25zdCBsaXN0ZW5zID0gQXJyYXkuZnJvbShsaXN0ZW5NYXAudmFsdWVzKCkpO1xuICAgIGNvbnN0IGFydGlzdHMgPSBBcnJheS5mcm9tKGFydGlzdE1hcC52YWx1ZXMoKSk7XG4gICAgY29uc3QgdHJhY2tBcnRpc3RzID0gdHJhY2tBcnRpc3RSb3dzO1xuXG4gICAgLy8gNykgV3JpdGUgd2l0aCBBRE1JTiBjbGllbnQgKGJ5cGFzcyBSTFMpIOKAlCB1bmlxdWUgcm93cyBvbmx5XG4gICAgY29uc3QgeyBlcnJvcjogdHJFcnIgfSA9IGF3YWl0IHN1cGFiYXNlQWRtaW5cbiAgICAgIC5mcm9tKFwic3BvdGlmeV90cmFja3NcIilcbiAgICAgIC51cHNlcnQodHJhY2tzLCB7IG9uQ29uZmxpY3Q6IFwiaWRcIiB9KTsgLy8gc2FmZSBiZWNhdXNlIHdlIGRlZHVwZWRcbiAgICBpZiAodHJFcnIpIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiB0ckVyci5tZXNzYWdlLCB3aGVyZTogXCJ0cmFja3MudXBzZXJ0XCIgfSwgeyBzdGF0dXM6IDQwMCB9KTtcblxuICAgIGNvbnN0IHsgZXJyb3I6IGFyRXJyIH0gPSBhd2FpdCBzdXBhYmFzZUFkbWluXG4gICAgICAuZnJvbShcInNwb3RpZnlfYXJ0aXN0c1wiKVxuICAgICAgLnVwc2VydChhcnRpc3RzLCB7IG9uQ29uZmxpY3Q6IFwiaWRcIiB9KTtcbiAgICBpZiAoYXJFcnIpIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiBhckVyci5tZXNzYWdlLCB3aGVyZTogXCJhcnRpc3RzLnVwc2VydFwiIH0sIHsgc3RhdHVzOiA0MDAgfSk7XG5cbiAgICBjb25zdCB7IGVycm9yOiB0YUVyciB9ID0gYXdhaXQgc3VwYWJhc2VBZG1pblxuICAgICAgLmZyb20oXCJzcG90aWZ5X3RyYWNrX2FydGlzdHNcIilcbiAgICAgIC51cHNlcnQodHJhY2tBcnRpc3RzLCB7IG9uQ29uZmxpY3Q6IFwidHJhY2tfaWQsYXJ0aXN0X2lkXCIgfSk7XG4gICAgaWYgKHRhRXJyKSByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyBlcnJvcjogdGFFcnIubWVzc2FnZSwgd2hlcmU6IFwidHJhY2tfYXJ0aXN0cy51cHNlcnRcIiB9LCB7IHN0YXR1czogNDAwIH0pO1xuXG4gICAgY29uc3QgeyBlcnJvcjogbHNFcnIgfSA9IGF3YWl0IHN1cGFiYXNlQWRtaW5cbiAgICAgIC5mcm9tKFwic3BvdGlmeV9saXN0ZW5zXCIpXG4gICAgICAudXBzZXJ0KGxpc3RlbnMsIHsgb25Db25mbGljdDogXCJ1c2VyX2lkLHRyYWNrX2lkLHBsYXllZF9hdFwiIH0pO1xuICAgIGlmIChsc0VycikgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgZXJyb3I6IGxzRXJyLm1lc3NhZ2UsIHdoZXJlOiBcImxpc3RlbnMudXBzZXJ0XCIgfSwgeyBzdGF0dXM6IDQwMCB9KTtcblxuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7XG4gICAgICBvazogdHJ1ZSxcbiAgICAgIGFwaVVybCxcbiAgICAgIGl0ZW1zX3JlY2VpdmVkOiBpdGVtcy5sZW5ndGgsXG4gICAgICBpbXBvcnRlZDogbGlzdGVucy5sZW5ndGgsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGU6IGFueSkge1xuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiBlPy5tZXNzYWdlIHx8IFN0cmluZyhlKSB9LCB7IHN0YXR1czogNTAwIH0pO1xuICB9XG59XG4iXSwibmFtZXMiOlsiTmV4dFJlc3BvbnNlIiwiaGVhZGVycyIsImNyZWF0ZUNsaWVudCIsInN1cGFiYXNlQWRtaW4iLCJnZXRCZWFyZXIiLCJoIiwiYSIsImdldCIsIm0iLCJtYXRjaCIsIlBPU1QiLCJyZXEiLCJ1cmwiLCJVUkwiLCJmdWxsIiwic2VhcmNoUGFyYW1zIiwiYmVhcmVyIiwianNvbiIsImVycm9yIiwic3RhdHVzIiwidXNlckNsaWVudCIsInByb2Nlc3MiLCJlbnYiLCJORVhUX1BVQkxJQ19TVVBBQkFTRV9VUkwiLCJORVhUX1BVQkxJQ19TVVBBQkFTRV9BTk9OX0tFWSIsImdsb2JhbCIsIkF1dGhvcml6YXRpb24iLCJhdXRoIiwicGVyc2lzdFNlc3Npb24iLCJkYXRhIiwidSIsInVFcnIiLCJnZXRVc2VyIiwidXNlciIsIm1lc3NhZ2UiLCJ1c2VySWQiLCJpZCIsImFjY3QiLCJhY2N0RXJyIiwiZnJvbSIsInNlbGVjdCIsImVxIiwibWF5YmVTaW5nbGUiLCJhY2Nlc3NUb2tlbiIsImFjY2Vzc190b2tlbiIsInJlZnJlc2hUb2tlbiIsInJlZnJlc2hfdG9rZW4iLCJleHAiLCJleHBpcmVzX2F0IiwiRGF0ZSIsImdldFRpbWUiLCJub3ciLCJiYXNlIiwiQVBQX0JBU0VfVVJMIiwicmVkaXJlY3QiLCJTUE9USUZZX1JFRElSRUNUX1VSSSIsInJlc3AiLCJmZXRjaCIsIm1ldGhvZCIsIkJ1ZmZlciIsIlNQT1RJRllfQ0xJRU5UX0lEIiwiU1BPVElGWV9DTElFTlRfU0VDUkVUIiwidG9TdHJpbmciLCJib2R5IiwiVVJMU2VhcmNoUGFyYW1zIiwiZ3JhbnRfdHlwZSIsInJlZGlyZWN0X3VyaSIsIm9rIiwidGV4dCIsInQiLCJuZXdFeHAiLCJNYXRoIiwibWF4IiwiZXhwaXJlc19pbiIsInVwZGF0ZSIsInRvSVNPU3RyaW5nIiwiYWZ0ZXJQYXJhbSIsImxhc3QiLCJvcmRlciIsImFzY2VuZGluZyIsImxpbWl0IiwicGxheWVkX2F0IiwiYXBpVXJsIiwic3BSZXMiLCJwYXlsb2FkIiwiaXRlbXMiLCJBcnJheSIsImlzQXJyYXkiLCJsZW5ndGgiLCJpdGVtc19yZWNlaXZlZCIsImltcG9ydGVkIiwidHJhY2tNYXAiLCJNYXAiLCJsaXN0ZW5NYXAiLCJhcnRpc3RNYXAiLCJ0cmFja0FydGlzdFNldCIsIlNldCIsInRyYWNrQXJ0aXN0Um93cyIsIml0IiwidHIiLCJ0cmFjayIsImhhcyIsImFydGlzdE5hbWUiLCJhcnRpc3RzIiwibWFwIiwibmFtZSIsImZpbHRlciIsIkJvb2xlYW4iLCJqb2luIiwiaW1nIiwiYWxidW0iLCJpbWFnZXMiLCJzZXQiLCJhcnRpc3RfbmFtZSIsImFsYnVtX2ltYWdlX3VybCIsInByZXZpZXdfdXJsIiwia2V5IiwiYWRkIiwicHVzaCIsInRyYWNrX2lkIiwiYXJ0aXN0X2lkIiwicGxheWVkQXRJc28iLCJ1c2VyX2lkIiwidHJhY2tzIiwidmFsdWVzIiwibGlzdGVucyIsInRyYWNrQXJ0aXN0cyIsInRyRXJyIiwidXBzZXJ0Iiwib25Db25mbGljdCIsIndoZXJlIiwiYXJFcnIiLCJ0YUVyciIsImxzRXJyIiwiZSIsIlN0cmluZyJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./app/api/spotify/my/sync/route.ts\n");

/***/ }),

/***/ "(rsc)/./lib/supabaseAdmin.ts":
/*!******************************!*\
  !*** ./lib/supabaseAdmin.ts ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   supabaseAdmin: () => (/* binding */ supabaseAdmin),\n/* harmony export */   supabaseService: () => (/* binding */ supabaseService),\n/* harmony export */   usingServiceRole: () => (/* binding */ usingServiceRole)\n/* harmony export */ });\n/* harmony import */ var _supabase_supabase_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @supabase/supabase-js */ \"(rsc)/./node_modules/@supabase/supabase-js/dist/module/index.js\");\n// lib/supabaseAdmin.ts\n\nconst url = \"https://awxeorfppxdsygnhxlth.supabase.co\";\nconst serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n// Expose whether the service role key is configured so API routes can bail early\nconst usingServiceRole = !!(url && serviceKey);\n// Lazily create a Supabase client that uses the service role key.  This should\n// only be used in server-side code as it has full access to the database.\nfunction supabaseService() {\n    if (!usingServiceRole) {\n        throw new Error(\"SUPABASE_SERVICE_ROLE_KEY is not set\");\n    }\n    return (0,_supabase_supabase_js__WEBPACK_IMPORTED_MODULE_0__.createClient)(url, serviceKey, {\n        auth: {\n            persistSession: false,\n            autoRefreshToken: false\n        }\n    });\n}\n// Convenience singleton for callers that just need a client instance.\nconst supabaseAdmin = usingServiceRole ? supabaseService() : null;\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9saWIvc3VwYWJhc2VBZG1pbi50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUEsdUJBQXVCO0FBQzhCO0FBRXJELE1BQU1DLE1BQU1DLDBDQUFvQztBQUNoRCxNQUFNRyxhQUFhSCxRQUFRQyxHQUFHLENBQUNHLHlCQUF5QjtBQUV4RCxpRkFBaUY7QUFDMUUsTUFBTUMsbUJBQW1CLENBQUMsQ0FBRU4sQ0FBQUEsT0FBT0ksVUFBUyxFQUFHO0FBRXRELCtFQUErRTtBQUMvRSwwRUFBMEU7QUFDbkUsU0FBU0c7SUFDZCxJQUFJLENBQUNELGtCQUFrQjtRQUNyQixNQUFNLElBQUlFLE1BQU07SUFDbEI7SUFDQSxPQUFPVCxtRUFBWUEsQ0FBQ0MsS0FBTUksWUFBYTtRQUNyQ0ssTUFBTTtZQUFFQyxnQkFBZ0I7WUFBT0Msa0JBQWtCO1FBQU07SUFDekQ7QUFDRjtBQUVBLHNFQUFzRTtBQUMvRCxNQUFNQyxnQkFBZ0JOLG1CQUFtQkMsb0JBQXFCLEtBQWEiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9zb3VuZG1pbmQvLi9saWIvc3VwYWJhc2VBZG1pbi50cz8wOWQ1Il0sInNvdXJjZXNDb250ZW50IjpbIi8vIGxpYi9zdXBhYmFzZUFkbWluLnRzXG5pbXBvcnQgeyBjcmVhdGVDbGllbnQgfSBmcm9tIFwiQHN1cGFiYXNlL3N1cGFiYXNlLWpzXCI7XG5cbmNvbnN0IHVybCA9IHByb2Nlc3MuZW52Lk5FWFRfUFVCTElDX1NVUEFCQVNFX1VSTDtcbmNvbnN0IHNlcnZpY2VLZXkgPSBwcm9jZXNzLmVudi5TVVBBQkFTRV9TRVJWSUNFX1JPTEVfS0VZO1xuXG4vLyBFeHBvc2Ugd2hldGhlciB0aGUgc2VydmljZSByb2xlIGtleSBpcyBjb25maWd1cmVkIHNvIEFQSSByb3V0ZXMgY2FuIGJhaWwgZWFybHlcbmV4cG9ydCBjb25zdCB1c2luZ1NlcnZpY2VSb2xlID0gISEodXJsICYmIHNlcnZpY2VLZXkpO1xuXG4vLyBMYXppbHkgY3JlYXRlIGEgU3VwYWJhc2UgY2xpZW50IHRoYXQgdXNlcyB0aGUgc2VydmljZSByb2xlIGtleS4gIFRoaXMgc2hvdWxkXG4vLyBvbmx5IGJlIHVzZWQgaW4gc2VydmVyLXNpZGUgY29kZSBhcyBpdCBoYXMgZnVsbCBhY2Nlc3MgdG8gdGhlIGRhdGFiYXNlLlxuZXhwb3J0IGZ1bmN0aW9uIHN1cGFiYXNlU2VydmljZSgpIHtcbiAgaWYgKCF1c2luZ1NlcnZpY2VSb2xlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiU1VQQUJBU0VfU0VSVklDRV9ST0xFX0tFWSBpcyBub3Qgc2V0XCIpO1xuICB9XG4gIHJldHVybiBjcmVhdGVDbGllbnQodXJsISwgc2VydmljZUtleSEsIHtcbiAgICBhdXRoOiB7IHBlcnNpc3RTZXNzaW9uOiBmYWxzZSwgYXV0b1JlZnJlc2hUb2tlbjogZmFsc2UgfSxcbiAgfSk7XG59XG5cbi8vIENvbnZlbmllbmNlIHNpbmdsZXRvbiBmb3IgY2FsbGVycyB0aGF0IGp1c3QgbmVlZCBhIGNsaWVudCBpbnN0YW5jZS5cbmV4cG9ydCBjb25zdCBzdXBhYmFzZUFkbWluID0gdXNpbmdTZXJ2aWNlUm9sZSA/IHN1cGFiYXNlU2VydmljZSgpIDogKG51bGwgYXMgYW55KTtcbiJdLCJuYW1lcyI6WyJjcmVhdGVDbGllbnQiLCJ1cmwiLCJwcm9jZXNzIiwiZW52IiwiTkVYVF9QVUJMSUNfU1VQQUJBU0VfVVJMIiwic2VydmljZUtleSIsIlNVUEFCQVNFX1NFUlZJQ0VfUk9MRV9LRVkiLCJ1c2luZ1NlcnZpY2VSb2xlIiwic3VwYWJhc2VTZXJ2aWNlIiwiRXJyb3IiLCJhdXRoIiwicGVyc2lzdFNlc3Npb24iLCJhdXRvUmVmcmVzaFRva2VuIiwic3VwYWJhc2VBZG1pbiJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./lib/supabaseAdmin.ts\n");

/***/ })

};
;

// load runtime
var __webpack_require__ = require("../../../../../webpack-runtime.js");
__webpack_require__.C(exports);
var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
var __webpack_exports__ = __webpack_require__.X(0, ["vendor-chunks/next","vendor-chunks/@supabase","vendor-chunks/tr46","vendor-chunks/whatwg-url","vendor-chunks/webidl-conversions"], () => (__webpack_exec__("(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fspotify%2Fmy%2Fsync%2Froute&page=%2Fapi%2Fspotify%2Fmy%2Fsync%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fspotify%2Fmy%2Fsync%2Froute.ts&appDir=%2FUsers%2Fcormackerr%2FDesktop%2Fsoundmind%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Fcormackerr%2FDesktop%2Fsoundmind&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!")));
module.exports = __webpack_exports__;

})();